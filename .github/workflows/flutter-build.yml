name: Flutter Build & Custom Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.7'
  JAVA_VERSION: '20'
  RELEASE_NAME: 'PneumoAI v2.0.0 - With Arduino v1'
  RELEASE_TAG: 'v2.0.0'
  RELEASE_BODY: "PneumoAI's first arduino attempt"

jobs:
  build:
    name: Build Flutter APK (Cached)
    runs-on: ubuntu-latest
    outputs:
      apk_exists: ${{ steps.find-apk.outputs.apk_exists }}
      apk_path: ${{ steps.find-apk.outputs.apk_path }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Cache Android SDK & Build Tools
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/android/sdk/build-tools
            /usr/local/lib/android/sdk/platform-tools
            /usr/local/lib/android/sdk/platforms
            /usr/local/lib/android/sdk/cmdline-tools
            /usr/local/lib/android/sdk/cmake
            /usr/local/lib/android/sdk/tools
          key: android-sdk-buildtools-${{ runner.os }}-34
          restore-keys: |
            android-sdk-buildtools-${{ runner.os }}-

      - name: Cache Android NDK
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/android/sdk/ndk
            /usr/local/lib/android/sdk/ndk-bundle
          key: android-ndk-${{ runner.os }}-r25c
          restore-keys: |
            android-ndk-${{ runner.os }}-

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-jdk${{ env.JAVA_VERSION }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-jdk${{ env.JAVA_VERSION }}-
            gradle-${{ runner.os }}-

      - name: Cache Android Build (exclude APKs)
        uses: actions/cache@v4
        with:
          path: |
            android/app/build/intermediates
            android/app/build/kotlin
            android/app/build/tmp
            build/app/intermediates
          key: android-build-${{ runner.os }}-${{ hashFiles('android/**/*.gradle*', 'pubspec.lock') }}
          restore-keys: |
            android-build-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Precache Flutter artifacts
        run: flutter precache --android

      - name: Configure Gradle for maximum performance
        run: |
          mkdir -p ~/.gradle
          cat > ~/.gradle/gradle.properties <<EOF
          org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -XX:+UseParallelGC
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.daemon=true
          org.gradle.configureondemand=true
          kotlin.compiler.execution.strategy=in-process
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

      - name: Set NDK version
        run: |
          echo "ndk.dir=/usr/local/lib/android/sdk/ndk-bundle" >> android/local.properties
          echo "sdk.dir=/usr/local/lib/android/sdk" >> android/local.properties

      - name: Configure Android build
        run: |
          if ! grep -q "ndkVersion" android/app/build.gradle; then
            sed -i '/android {/a \    ndkVersion flutter.ndkVersion' android/app/build.gradle
          fi

      - name: Build release APK (all ABIs)
        run: flutter build apk --release

      - name: Find and verify APK (Robust Search)
        id: find-apk
        run: |
          echo "ðŸ” Searching for APK files..."
          
          # âœ… Primary locations to check
          POSSIBLE_PATHS=(
            "build/app/outputs/flutter-apk/app-release.apk"
            "android/app/build/outputs/flutter-apk/app-release.apk"
            "android/app/build/outputs/apk/release/app-release.apk"
          )
          
          APK_FOUND=false
          APK_PATH=""
          
          # Check predefined paths first
          for path in "${POSSIBLE_PATHS[@]}"; do
            echo "Checking: $path"
            if [ -f "$path" ]; then
              echo "âœ… Found APK at: $path"
              APK_PATH="$path"
              APK_FOUND=true
              break
            fi
          done
          
          # âœ… If not found, search entire workspace
          if [ "$APK_FOUND" = false ]; then
            echo "âš ï¸ APK not found in expected locations. Performing deep search..."
            
            # Find all APK files (excluding cached/old builds)
            FOUND_APKS=$(find . -name "app-release.apk" -type f -not -path "*/cache/*" -not -path "*/.gradle/*" 2>/dev/null)
            
            if [ -n "$FOUND_APKS" ]; then
              # Use the first found APK
              APK_PATH=$(echo "$FOUND_APKS" | head -n 1)
              echo "âœ… Found APK via deep search: $APK_PATH"
              APK_FOUND=true
            else
              echo "âŒ No APK files found anywhere in workspace!"
              echo "ðŸ“‚ Listing build directory structure:"
              ls -R build/ 2>/dev/null || echo "build/ directory doesn't exist"
              ls -R android/app/build/outputs/ 2>/dev/null || echo "android outputs directory doesn't exist"
            fi
          fi
          
          # âœ… Set outputs (don't exit 1 - let the job continue)
          if [ "$APK_FOUND" = true ]; then
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "apk_exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ APK Details:"
            ls -lh "$APK_PATH"
            echo "âœ… APK verification successful!"
          else
            echo "apk_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ APK verification failed - will skip upload"
          fi

      - name: Upload build artifact
        if: steps.find-apk.outputs.apk_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: ${{ steps.find-apk.outputs.apk_path }}
          compression-level: 0

      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.find-apk.outputs.apk_exists }}" = "true" ]; then
            echo "âœ… **Build Status:** SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **APK Location:** \`${{ steps.find-apk.outputs.apk_path }}\`" >> $GITHUB_STEP_SUMMARY
            APK_SIZE=$(du -h "${{ steps.find-apk.outputs.apk_path }}" | cut -f1)
            echo "ðŸ“ **APK Size:** $APK_SIZE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build Status:** FAILED" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ APK file was not generated or could not be found" >> $GITHUB_STEP_SUMMARY
          fi

  release:
    name: Create Custom GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.apk_exists == 'true'
    permissions:
      contents: write
    
    steps:
      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release
          path: build-output

      - name: List downloaded files
        run: |
          echo "ðŸ“‚ Downloaded files:"
          ls -lah build-output/

      - name: Verify downloaded APK
        id: verify-apk
        run: |
          APK_FILE=$(find build-output -name "*.apk" -type f | head -n 1)
          
          if [ -z "$APK_FILE" ]; then
            echo "âŒ No APK found in downloaded artifacts!"
            ls -R build-output/
            exit 1
          fi
          
          echo "âœ… Found APK: $APK_FILE"
          echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT

      - name: Rename APK for release
        run: |
          APK_SOURCE="${{ steps.verify-apk.outputs.apk_file }}"
          APK_TARGET="build-output/PneumoAI-${{ env.RELEASE_TAG }}.apk"
          
          mv "$APK_SOURCE" "$APK_TARGET"
          echo "âœ… APK renamed to: $APK_TARGET"
          ls -lh "$APK_TARGET"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body: |
            ${{ env.RELEASE_BODY }}
            
            ## ðŸ“¦ Download
            - **APK Size:** $(du -h build-output/PneumoAI-${{ env.RELEASE_TAG }}.apk | cut -f1)
            - **Built with:** Flutter ${{ env.FLUTTER_VERSION }}
            - **Target SDK:** Android 34
            
            ## ðŸ”§ Installation
            1. Download the APK file below
            2. Enable "Install from Unknown Sources" on your Android device
            3. Install and enjoy!
          files: build-output/PneumoAI-${{ env.RELEASE_TAG }}.apk
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        if: always()
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Release Created:** ${{ env.RELEASE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸ **Tag:** ${{ env.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **APK:** PneumoAI-${{ env.RELEASE_TAG }}.apk" >> $GITHUB_STEP_SUMMARY