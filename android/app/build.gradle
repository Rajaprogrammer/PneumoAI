plugins {
    id 'com.android.application'
    id 'kotlin-android'
    id 'dev.flutter.flutter-gradle-plugin'
    // id 'com.chaquo.python' // ****CHAQUOPY DISABLED TEMPORARILY - DO NOT REMOVE ANY FILES RELATED TO IT ****
    id 'kotlin-kapt'
}

def localProperties = new Properties()
def localPropertiesFile = rootProject.file('local.properties')
if (localPropertiesFile.exists()) {
    localProperties.load(localPropertiesFile.newReader('UTF-8'))
}

def flutterVersionCode = localProperties.getProperty('flutter.versionCode') ?: '1'
def flutterVersionName = localProperties.getProperty('flutter.versionName') ?: '1.0'

android {
    namespace 'com.example.pneumoai_6'
    compileSdk 36
    ndkVersion "25.2.9519653"

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_20
        targetCompatibility JavaVersion.VERSION_20
    }

    kotlinOptions {
        jvmTarget = "20"
    }

    sourceSets {
        main.java.srcDirs += 'src/main/kotlin'
        main.assets.srcDirs += 'src/main/assets'
    }

    defaultConfig {
        applicationId "com.example.pneumoai_6"
        minSdk 24
        targetSdk 34
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName
        multiDexEnabled true

        ndk {
            // Include all common ABIs for universal compatibility
            abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64"
        }

        aaptOptions {
            noCompress "tflite", "ptl", "pt", "onnx", "bin"
        }
    }

    buildTypes {
        release {
            minifyEnabled false
            shrinkResources false

            // ✅ Use the default debug keystore to sign release builds too
            // so the APK installs everywhere without needing a custom keystore.
            signingConfig signingConfigs.debug

            // ✅ Build one universal APK (no ABI splits)
            splits {
                abi {
                    enable false
                }
            }

            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }

        debug {
            minifyEnabled false
            shrinkResources false
        }
    }

    packagingOptions {
        pickFirst 'lib/x86/libc++_shared.so'
        pickFirst 'lib/x86_64/libc++_shared.so'
        pickFirst 'lib/armeabi-v7a/libc++_shared.so'
        pickFirst 'lib/arm64-v8a/libc++_shared.so'
        pickFirst 'lib/arm64-v8a/libfbjni.so'
        pickFirst 'lib/armeabi-v7a/libfbjni.so'

        exclude 'META-INF/DEPENDENCIES'
        exclude 'META-INF/LICENSE*'
        exclude 'META-INF/NOTICE*'
        exclude 'META-INF/ASL2.0'
        exclude 'META-INF/*.kotlin_module'

        jniLibs {
            useLegacyPackaging = true
        }

        resources {
            excludes += [
                'META-INF/DEPENDENCIES',
                'META-INF/LICENSE',
                'META-INF/NOTICE',
                '/META-INF/{AL2.0,LGPL2.1}'
            ]
            pickFirsts += ['**/*.ptl', '**/*.tflite']
        }

        androidResources {
            noCompress 'tflite', 'ptl', 'pt', 'onnx', 'bin'
        }
    }
}

flutter {
    source '../..'
}

// --- Chaquopy (currently disabled) ---
// chaquopy {
//     defaultConfig {
//         buildPython "C:/Users/CA Articles/AppData/Local/Programs/Python/Python311/python.exe"
//         pip {
//             install "requests"
//             install "numpy"
//             install "pillow"
//             install "tflite-runtime==2.5.0"
//         }
//     }
// }

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
    implementation 'androidx.core:core-ktx:1.10.1'
    implementation 'androidx.appcompat:appcompat:1.7.0'

    implementation 'org.tensorflow:tensorflow-lite:2.12.0'
    implementation 'org.tensorflow:tensorflow-lite-support:0.4.3'
    implementation 'org.tensorflow:tensorflow-lite-gpu:2.12.0'
    implementation 'org.tensorflow:tensorflow-lite-select-tf-ops:2.12.0'

    implementation 'org.pytorch:pytorch_android:1.10.0'
    implementation 'org.pytorch:pytorch_android_torchvision:1.10.0'
    implementation 'com.facebook.soloader:soloader:0.10.5'
    implementation 'com.facebook.fbjni:fbjni-java-only:0.2.2'
}
