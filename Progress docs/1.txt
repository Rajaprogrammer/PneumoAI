--- Contents of: E:/PneumoAI/Application/pneumoai_6_to_send/lib ---

    üìÑ auth.dart

       --- File Content Start ---

import 'package:flutter/material.dart';
import 'package:pattern_lock/pattern_lock.dart';
import 'package:local_auth/local_auth.dart';
import 'package:shared_preferences/shared_preferences.dart';

enum AuthMethod { face, fingerprint, pattern }

class AppAuth {
  static const _pinKey = 'app_pattern_v1';
  // Legacy reset PIN no longer used; retained for potential future flows
  // static const _resetPin = '1234';
  static const _methodKey = 'app_auth_method_v1';

  // ---------------- Storage helpers ----------------
  static Future<String?> _getStoredPin() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString(_pinKey);
  }

  static Future<void> _setStoredPin(String pin) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_pinKey, pin);
  }

  static Future<AuthMethod?> _getStoredMethod() async {
    final prefs = await SharedPreferences.getInstance();
    final s = prefs.getString(_methodKey);
    if (s == 'face') return AuthMethod.face;
    if (s == 'fingerprint') return AuthMethod.fingerprint;
    if (s == 'pattern') return AuthMethod.pattern;
    return null;
  }

  static Future<void> _setStoredMethod(AuthMethod m) async {
    final prefs = await SharedPreferences.getInstance();
    final s = m == AuthMethod.face
        ? 'face'
        : (m == AuthMethod.fingerprint ? 'fingerprint' : 'pattern');
    await prefs.setString(_methodKey, s);
  }

  // ---------------- Biometrics ----------------
  static Future<bool> _tryBiometric(AuthMethod method) async {
    final auth = LocalAuthentication();
    final canCheck =
        await auth.canCheckBiometrics || await auth.isDeviceSupported();
    if (!canCheck) return false;

    final available = await auth.getAvailableBiometrics();
    // Prefer requested method, otherwise fail
    final wantsFace = method == AuthMethod.face;
    final wantsFp = method == AuthMethod.fingerprint;
    final hasFace =
        available.contains(BiometricType.face) ||
        available.contains(BiometricType.strong);
    final hasFp =
        available.contains(BiometricType.fingerprint) ||
        available.contains(BiometricType.weak);

    if ((wantsFace && !hasFace) || (wantsFp && !hasFp)) return false;

    return await auth.authenticate(
      localizedReason: wantsFace
          ? 'Authenticate with Face'
          : 'Authenticate with Fingerprint',
      options: const AuthenticationOptions(
        biometricOnly: true,
        stickyAuth: true,
        sensitiveTransaction: true,
      ),
    );
  }

  // ---------------- Pattern dialogs ----------------
  static Future<bool> _showPatternVerifyDialog(
    BuildContext context,
    String stored,
  ) async {
    bool authed = false;
    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (ctx) {
        return AlertDialog(
          title: const Text('Draw pattern to unlock'),
          content: SizedBox(
            width: 300,
            height: 360,
            child: PatternLock(
              selectedColor: Colors.blueAccent,
              pointRadius: 10,
              onInputComplete: (input) {
                final entered = input.join(',');
                if (entered == stored) {
                  authed = true;
                  Navigator.of(ctx).pop();
                }
              },
            ),
          ),
        );
      },
    );
    return authed;
  }

  static Future<bool> _showPatternCreateDialog(BuildContext context) async {
    String pattern = '';
    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (ctx) {
        return AlertDialog(
          title: const Text('Set your pattern'),
          content: SizedBox(
            width: 300,
            height: 360,
            child: PatternLock(
              selectedColor: Colors.blueAccent,
              pointRadius: 10,
              onInputComplete: (input) {
                pattern = input.join(',');
                Navigator.of(ctx).pop();
              },
            ),
          ),
        );
      },
    );
    if (pattern.isEmpty) return false;
    await _setStoredPin(pattern);
    return true;
  }

  // ---------------- Method selection ----------------
  static Future<AuthMethod?> _selectInitialMethod(BuildContext context) async {
    final auth = LocalAuthentication();
    final available = await auth.getAvailableBiometrics();
    final hasFace =
        available.contains(BiometricType.face) ||
        available.contains(BiometricType.strong);
    final hasFp =
        available.contains(BiometricType.fingerprint) ||
        available.contains(BiometricType.weak);

    AuthMethod? chosen;
    await showDialog(
      context: context,
      barrierDismissible: false,
      builder: (ctx) {
        return AlertDialog(
          title: const Text('Choose unlock method'),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              if (hasFace)
                ListTile(
                  leading: const Icon(Icons.face_retouching_natural),
                  title: const Text('Face recognition'),
                  onTap: () {
                    chosen = AuthMethod.face;
                    Navigator.of(ctx).pop();
                  },
                ),
              if (hasFp)
                ListTile(
                  leading: const Icon(Icons.fingerprint),
                  title: const Text('Fingerprint'),
                  onTap: () {
                    chosen = AuthMethod.fingerprint;
                    Navigator.of(ctx).pop();
                  },
                ),
              ListTile(
                leading: const Icon(Icons.pattern),
                title: const Text('Pattern'),
                onTap: () {
                  chosen = AuthMethod.pattern;
                  Navigator.of(ctx).pop();
                },
              ),
            ],
          ),
        );
      },
    );
    return chosen;
  }

  // Public API: authenticate using stored method; on first run, choose and persist.
  static Future<bool> ensureAuthenticated(BuildContext context) async {
    AuthMethod? method = await _getStoredMethod();
    if (method == null) {
      method = await _selectInitialMethod(context);
      if (method == null) return false;
      await _setStoredMethod(method);
      if (method == AuthMethod.pattern) {
        final ok = await _showPatternCreateDialog(context);
        if (!ok) return false;
      }
    }

    // Execute chosen method
    if (method == AuthMethod.face || method == AuthMethod.fingerprint) {
      final ok = await _tryBiometric(method);
      if (ok) return true;
      // If preferred biometrics unavailable/fails, fallback order: other biometric -> pattern
      final other = method == AuthMethod.face
          ? AuthMethod.fingerprint
          : AuthMethod.face;
      if (await _tryBiometric(other)) return true;
      final stored = await _getStoredPin();
      if (stored != null)
        return await _showPatternVerifyDialog(context, stored);
      // If no pattern yet, ask to set and then unlock
      final created = await _showPatternCreateDialog(context);
      if (!created) return false;
      return await _showPatternVerifyDialog(context, (await _getStoredPin())!);
    } else {
      // Pattern flow
      final stored = await _getStoredPin();
      if (stored == null) {
        final ok = await _showPatternCreateDialog(context);
        if (!ok) return false;
        return await _showPatternVerifyDialog(
          context,
          (await _getStoredPin())!,
        );
      }
      return await _showPatternVerifyDialog(context, stored);
    }
  }

  // Expose a UI to change the default method anytime
  static Future<void> showChangeAuthMethodDialog(BuildContext context) async {
    final newMethod = await _selectInitialMethod(context);
    if (newMethod == null) return;
    await _setStoredMethod(newMethod);
    if (newMethod == AuthMethod.pattern) {
      // Ensure a pattern exists
      final stored = await _getStoredPin();
      if (stored == null || stored.isEmpty) {
        await _showPatternCreateDialog(context);
      }
    }
    // For biometrics, OS enrollment is assumed
    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Authentication method updated')),
      );
    }
  }
}


       --- File Content End ---


    üìÑ chest_xray.dart

       --- File Content Start ---

// lib/chest_xray.dart
import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'scale.dart';
import 'xray_upload.dart';
import 'xray_picture.dart';

class ChestXRayPage extends StatefulWidget {
  // ‚úÖ Changed to StatefulWidget
  const ChestXRayPage({super.key});

  @override
  _ChestXRayPageState createState() => _ChestXRayPageState();
}

class _ChestXRayPageState extends State<ChestXRayPage> {
  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  // ‚úÖ ADD: Initialize TTS
  @override
  void initState() {
    super.initState();
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Initialize TTS and speak welcome message
  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak welcome message
      await Future.delayed(const Duration(milliseconds: 300));
      await _speak(
        "Choose how to analyze your chest X-ray. You can upload an image or take a picture",
      );
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  // ‚úÖ ADD: Dispose TTS
  @override
  void dispose() {
    _flutterTts.stop();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // --- Screen-specific constants ---
    // Lungs AI Image (top-left)
    const lungsWidth = 120.0;
    const lungsHeight = 160.0;
    const lungsLeft = 0.0;
    const lungsTop = 0.0;

    // Title text
    const titleFontSize = 60.0;
    const titleLeft = 180.0;
    const titleTop = 30.0;
    const titleColor = Color(0xFF0d3b66);

    // Main X-ray image (left-central)
    const xrayWidth = 400.0;
    const xrayHeight = 500.0;
    const xrayLeft = 50.0;
    const xrayTop = 200.0;
    const xrayBorderRadius = 40.0;

    // Buttons
    const buttonWidth = 600.0;
    const buttonHeight = 180.0;
    const buttonBorderRadius = 90.0;
    const buttonBackgroundColor = Color(0xFF4B0082); // dark purple
    const buttonTextSize = 32.0;
    const buttonTextColor = Colors.white;
    const iconSize = 130.0;
    const iconTextSpacing = 24.0;

    // Button 1
    const btn1Left = 650.0;
    const btn1Top = 220.0;
    const btn1Icon = 'assets/upload_icon.png';
    const btn1Text = "Upload Your Chest X-Ray for AI Analyzation";

    // Button 2
    const btn2Left = 650.0;
    const btn2Top = 500.0;
    const btn2Icon = 'assets/camera_icon.png';
    const btn2Text = "Take a Picture Of Your Chest X-Ray";

    return Scaffold(
      body: Stack(
        children: [
          // Full background image
          Positioned.fill(
            child: Image.asset('assets/background.png', fit: BoxFit.cover),
          ),

          // Lungs AI image (top-left)
          Positioned(
            left: S.w(context, lungsLeft),
            top: S.h(context, lungsTop),
            child: SizedBox(
              width: S.w(context, lungsWidth),
              height: S.h(context, lungsHeight),
              child: Image.asset('assets/lungs_ai.png', fit: BoxFit.contain),
            ),
          ),

          // Title text
          Positioned(
            left: S.w(context, titleLeft),
            top: S.h(context, titleTop),
            child: Text(
              "Analyze Your Chest X-Ray With AI",
              style: TextStyle(
                fontSize: S.fs(context, titleFontSize),
                fontWeight: FontWeight.bold,
                color: titleColor,
              ),
            ),
          ),

          // Main X-ray image
          Positioned(
            left: S.w(context, xrayLeft),
            top: S.h(context, xrayTop),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(
                S.w(context, xrayBorderRadius),
              ),
              child: SizedBox(
                width: S.w(context, xrayWidth),
                height: S.h(context, xrayHeight),
                child: Image.asset('assets/xray_icon.png', fit: BoxFit.cover),
              ),
            ),
          ),

          // Button 1: Upload
          Positioned(
            left: S.w(context, btn1Left),
            top: S.h(context, btn1Top),
            child: SizedBox(
              width: S.w(context, buttonWidth),
              height: S.h(context, buttonHeight),
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: buttonBackgroundColor,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(
                      S.w(context, buttonBorderRadius),
                    ),
                  ),
                  elevation: 8,
                ),
                onPressed: () {
                  // ‚úÖ Speak before navigating
                  _speak("Upload chest X-ray");

                  Navigator.of(context).push(
                    MaterialPageRoute(
                      builder: (context) => const XRayUploadPage(),
                    ),
                  );
                },
                child: Row(
                  children: [
                    SizedBox(
                      width: S.w(context, iconSize),
                      height: S.h(context, iconSize),
                      child: Image.asset(btn1Icon),
                    ),
                    SizedBox(width: S.w(context, iconTextSpacing)),
                    Expanded(
                      child: Text(
                        btn1Text,
                        style: TextStyle(
                          fontSize: S.fs(context, buttonTextSize),
                          fontWeight: FontWeight.bold,
                          color: buttonTextColor,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),

          // Button 2: Take Picture
          Positioned(
            left: S.w(context, btn2Left),
            top: S.h(context, btn2Top),
            child: SizedBox(
              width: S.w(context, buttonWidth),
              height: S.h(context, buttonHeight),
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: buttonBackgroundColor,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(
                      S.w(context, buttonBorderRadius),
                    ),
                  ),
                  elevation: 8,
                ),
                onPressed: () {
                  // ‚úÖ Speak before navigating
                  _speak("Take a picture of chest X-ray");

                  Navigator.of(context).push(
                    MaterialPageRoute(
                      builder: (context) => const XRayPicturePage(),
                    ),
                  );
                },
                child: Row(
                  children: [
                    SizedBox(
                      width: S.w(context, iconSize),
                      height: S.h(context, iconSize),
                      child: Image.asset(btn2Icon),
                    ),
                    SizedBox(width: S.w(context, iconTextSpacing)),
                    Expanded(
                      child: Text(
                        btn2Text,
                        style: TextStyle(
                          fontSize: S.fs(context, buttonTextSize),
                          fontWeight: FontWeight.bold,
                          color: buttonTextColor,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),

          // ‚úÖ ADD: Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 20,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 10,
                  vertical: 5,
                ),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.8),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 16),
                    SizedBox(width: 5),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }
}


       --- File Content End ---


    üìÑ live_recording.dart

       --- File Content Start ---

import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS

class LiveRecordingPage extends StatefulWidget {
  // ‚úÖ Changed to StatefulWidget
  const LiveRecordingPage({super.key});

  @override
  _LiveRecordingPageState createState() => _LiveRecordingPageState();
}

class _LiveRecordingPageState extends State<LiveRecordingPage> {
  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  @override
  void initState() {
    super.initState();
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Initialize TTS and speak welcome message
  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak welcome message
      await Future.delayed(const Duration(milliseconds: 300));
      await _speak(
        "Tap start recording to record your lung sounds for AI analysis",
      );
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  // ‚úÖ ADD: Dispose TTS
  @override
  void dispose() {
    _flutterTts.stop();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // üé® Color options
    const backgroundColor = Colors.white;
    const mainTextColor = Color(0xFF0d3b66);
    const buttonColor = Color(0xFF4B0082); // dark purple
    const buttonTextColor = Colors.white;

    // üñº Top-left lungs_ai.png
    const lungsWidth = 120.0;
    const lungsHeight = 160.0;
    const lungsLeft = 0.0;
    const lungsTop = 0.0;

    const titleFontSize = 60.0;
    const titleLeft = 180.0;
    const titleTop = 30.0;

    // üñº Lung illustration
    const lungWidth = 800.0;
    const lungHeight = 700.0;
    const lungLeft = -140.0;
    const lungTop = 130.0;

    // üîò Recording button
    const buttonWidth = 500.0;
    const buttonHeight = 500.0;
    const buttonBorderRadius = 100.0;

    // üé§ Microphone inside button
    const micWidth = 250.0;
    const micHeight = 250.0;
    const micLeft = 90.0; // relative to button
    const micTop = 90.0;

    const buttonTextFontSize = 50.0;
    const buttonTextLeft = 55.0; // relative to button
    const buttonTextTop = 380.0;

    const buttonLeft = 700.0;
    const buttonTop = 220.0;

    return Scaffold(
      backgroundColor: backgroundColor,
      body: Stack(
        children: [
          // üåÑ Full background
          Positioned.fill(
            child: Image.asset('assets/background.png', fit: BoxFit.cover),
          ),

          // Top-left lungs_ai.png
          Positioned(
            left: lungsLeft,
            top: lungsTop,
            width: lungsWidth,
            height: lungsHeight,
            child: Image.asset('assets/lungs_ai.png', fit: BoxFit.contain),
          ),

          // Title text
          Positioned(
            left: titleLeft,
            top: titleTop,
            child: Text(
              "Record Your Lung Sounds With AI",
              style: TextStyle(
                fontSize: titleFontSize,
                fontWeight: FontWeight.bold,
                color: mainTextColor,
              ),
            ),
          ),

          // Lung illustration image
          Positioned(
            left: lungLeft,
            top: lungTop,
            width: lungWidth,
            height: lungHeight,
            child: ClipRRect(
              borderRadius: BorderRadius.circular(30),
              child: Image.asset('assets/lungs_icon.png', fit: BoxFit.cover),
            ),
          ),

          // Recording button
          Positioned(
            left: buttonLeft,
            top: buttonTop,
            width: buttonWidth,
            height: buttonHeight,
            child: ElevatedButton(
              style: ElevatedButton.styleFrom(
                backgroundColor: buttonColor,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(buttonBorderRadius),
                ),
                elevation: 8,
              ),
              onPressed: () {
                // ‚úÖ Speak before navigating
                _speak("Starting live recording");

                Navigator.pushNamed(context, '/loadingStethoscope');
              },
              child: Stack(
                children: [
                  // Microphone icon
                  Positioned(
                    left: micLeft,
                    top: micTop,
                    width: micWidth,
                    height: micHeight,
                    child: Image.asset(
                      'assets/record_icon.png',
                      fit: BoxFit.contain,
                    ),
                  ),

                  // Start Recording text
                  Positioned(
                    left: buttonTextLeft,
                    top: buttonTextTop,
                    child: Text(
                      "Start Recording",
                      style: TextStyle(
                        fontSize: buttonTextFontSize,
                        fontWeight: FontWeight.bold,
                        color: buttonTextColor,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),

          // ‚úÖ ADD: Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 20,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 10,
                  vertical: 5,
                ),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.8),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 16),
                    SizedBox(width: 5),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }
}


       --- File Content End ---


    üìÑ loading_stethoscope.dart

       --- File Content Start ---

// lib/loading_stethoscope.dart
import 'dart:async';
import 'dart:math';
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'result.dart';

/// LoadingStethoscopePage
/// - Requests microphone permission on first use
/// - Starts mic access when recording begins
/// - Stops mic access when "Stop Recording" is clicked
class LoadingStethoscopePage extends StatefulWidget {
  const LoadingStethoscopePage({super.key});

  @override
  State<LoadingStethoscopePage> createState() => _LoadingStethoscopePageState();
}

class _LoadingStethoscopePageState extends State<LoadingStethoscopePage>
    with TickerProviderStateMixin {
  // Standard header assets
  static const String backgroundAsset = 'assets/background.png';
  static const String lungsAsset = 'assets/lungs_ai.png';

  // Pattern storage key
  static const String _kPatternKey = 'steth_pattern';

  // State
  SharedPreferences? _prefs;
  String? _storedPattern;
  bool _isSettingPattern = false;
  bool _patternVerified = false;
  bool _showWrongPattern = false;
  bool _showBreathingAnimation = false;

  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  // Microphone state
  bool _isMicActive = false;
  bool _hasMicPermission = false;

  // For pattern drawing
  final List<int> _selected = [];
  Offset? _currentPointer;
  bool _isDrawing = false;

  // UI / sequence
  String _overlayText = '';
  bool _overlayVisible = false;
  bool _showStopButton = false;
  bool _isProcessingStop = false;

  // constants for button
  static const double buttonWidth = 500.0;
  static const double buttonHeight = 500.0;
  static const double buttonBorderRadius = 100.0;
  static const double micWidth = 250.0;
  static const double micHeight = 250.0;
  static const double micLeft = 120.0;
  static const double micTop = 90.0;
  static const double buttonTextFontSize = 50.0;
  static const double buttonTextLeft = 70.0;
  static const double buttonTextTop = 380.0;

  // animation helpers
  Timer? _countdownTimer;
  late Random _rnd;

  @override
  void initState() {
    _rnd = Random();
    super.initState();
    _initTts(); // ‚úÖ ADD: Initialize TTS
    _initPrefs();
  }

  // ‚úÖ ADD: Initialize TTS
  Future<void> _initTts() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  Future<void> _initPrefs() async {
    _prefs = await SharedPreferences.getInstance();
    _storedPattern = _prefs!.getString(_kPatternKey);
    if (_storedPattern == null) {
      setState(() {
        _isSettingPattern = true;
      });
      // ‚úÖ Speak pattern setup instruction
      await _speak("Set your unlock pattern");
    } else {
      // ‚úÖ Speak pattern unlock instruction
      await _speak("Draw your pattern to unlock");
    }
  }

  Future<void> _savePattern(String pattern) async {
    _prefs ??= await SharedPreferences.getInstance();
    await _prefs!.setString(_kPatternKey, pattern);
    _storedPattern = pattern;
  }

  String _patternToString(List<int> sel) => sel.join(',');

  Future<bool> _requestMicPermission() async {
    final status = await Permission.microphone.status;

    if (status.isGranted) {
      setState(() => _hasMicPermission = true);
      return true;
    }

    if (status.isDenied) {
      final result = await Permission.microphone.request();
      if (result.isGranted) {
        setState(() => _hasMicPermission = true);
        return true;
      } else if (result.isPermanentlyDenied) {
        _showPermissionDeniedDialog();
        return false;
      }
    }

    if (status.isPermanentlyDenied) {
      _showPermissionDeniedDialog();
      return false;
    }

    return false;
  }

  void _showPermissionDeniedDialog() {
    _speak("Microphone permission required");

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Microphone Permission Required'),
        content: const Text(
          'This app needs microphone access to analyze breathing sounds. '
          'Please enable it in Settings.',
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('Cancel'),
          ),
          ElevatedButton(
            onPressed: () {
              openAppSettings();
              Navigator.of(context).pop();
            },
            child: const Text('Open Settings'),
          ),
        ],
      ),
    );
  }

  Future<void> _startMicAccess() async {
    if (!_hasMicPermission) return;

    setState(() => _isMicActive = true);
    debugPrint('üé§ Microphone access started');

    // ‚úÖ Speak mic activation
    await _speak("Microphone activated");
  }

  void _stopMicAccess() {
    if (_isMicActive) {
      setState(() => _isMicActive = false);
      debugPrint('üé§ Microphone access stopped');

      // ‚úÖ Speak mic deactivation
      _speak("Recording stopped. Analyzing audio");
    }
  }

  void _finishDrawingPattern() async {
    final s = _patternToString(_selected);
    if (_isSettingPattern) {
      if (_selected.length < 4) {
        _showTemporaryMessage(
          'Pattern too short ‚Äî use at least 4 dots',
          isError: true,
        );

        // ‚úÖ Speak error
        await _speak("Pattern too short. Use at least 4 dots");

        _clearDrawing();
        return;
      }
      await _savePattern(s);
      setState(() {
        _isSettingPattern = false;
        _patternVerified = true;
      });
      _clearDrawing();

      // ‚úÖ Speak pattern saved
      await _speak("Pattern saved successfully");

      final hasPermission = await _requestMicPermission();
      if (!hasPermission) {
        _showTemporaryMessage('Microphone permission required', isError: true);
        return;
      }

      _startRecordingSequence();
      return;
    }

    // verify pattern
    if (_storedPattern == s) {
      setState(() => _patternVerified = true);
      _clearDrawing();

      // ‚úÖ Speak pattern verified
      await _speak("Pattern verified");

      final hasPermission = await _requestMicPermission();
      if (!hasPermission) {
        _showTemporaryMessage('Microphone permission required', isError: true);
        setState(() => _patternVerified = false);
        return;
      }

      _startRecordingSequence();
    } else {
      setState(() {
        _showWrongPattern = true;
      });
      _showTemporaryMessage('Wrong pattern', isError: true);

      // ‚úÖ Speak wrong pattern
      await _speak("Wrong pattern. Try again");

      Future.delayed(const Duration(seconds: 1), () {
        if (mounted) {
          setState(() {
            _showWrongPattern = false;
            _clearDrawing();
          });
        }
      });
    }
  }

  void _clearDrawing() {
    setState(() {
      _selected.clear();
      _currentPointer = null;
      _isDrawing = false;
    });
  }

  void _showTemporaryMessage(
    String text, {
    bool isError = false,
    int ms = 900,
  }) {
    setState(() {
      _overlayText = text;
      _overlayVisible = true;
    });
    Future.delayed(Duration(milliseconds: ms), () {
      if (mounted) {
        setState(() => _overlayVisible = false);
      }
    });
  }

  Future<void> _startRecordingSequence() async {
    if (!mounted) return;

    // Countdown
    await _showFadeText('Recording starting in..', 900);
    await _speak("Recording starting in");
    await Future.delayed(const Duration(milliseconds: 160));

    for (int n = 3; n >= 1; n--) {
      await _showFadeText('$n', 700);
      await _speak('$n');
      await Future.delayed(const Duration(milliseconds: 160));
    }

    await _showFadeText('Start', 900);
    await _speak('Start');
    await Future.delayed(const Duration(milliseconds: 300));

    await _startMicAccess();

    // Breathing cycles
    if (mounted) setState(() => _showBreathingAnimation = true);

    for (int cycle = 0; cycle < 3; cycle++) {
      await _showFadeText('Please breathe in deeply', 2000);
      await _speak('Please breathe in deeply');
      await Future.delayed(const Duration(milliseconds: 180));

      await _showFadeText('Please breathe out deeply', 2000);
      await _speak('Please breathe out deeply');
      await Future.delayed(const Duration(milliseconds: 180));
    }

    if (mounted) {
      setState(() {
        _showStopButton = true;
        _showBreathingAnimation = false;
      });

      // ‚úÖ Speak stop instruction
      await _speak("Tap stop recording when ready");
    }
  }

  Future<void> _showFadeText(
    String text,
    int millis, {
    bool keep = false,
  }) async {
    if (!mounted) return;
    setState(() {
      _overlayText = text;
      _overlayVisible = true;
    });
    await Future.delayed(Duration(milliseconds: millis));
    if (mounted && !keep) setState(() => _overlayVisible = false);
    await Future.delayed(const Duration(milliseconds: 120));
  }

  Future<void> _showPinDialogForChange() async {
    final ok = await showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (context) {
        return _PinAuthDialog();
      },
    );
    if (ok == true) {
      setState(() {
        _isSettingPattern = true;
        _patternVerified = false;
        _showStopButton = false;
        _clearDrawing();
      });
      _showTemporaryMessage('Draw new pattern');

      // ‚úÖ Speak pattern change
      await _speak("Draw new pattern");
    }
  }

  void _onStopTapped(Offset localPos) {
    if (_isProcessingStop) return;

    _stopMicAccess();

    setState(() => _isProcessingStop = true);

    final double w = buttonWidth;
    final double h = buttonHeight;
    final double x = localPos.dx.clamp(0.0, w);
    final double y = localPos.dy.clamp(0.0, h);
    final double yLine = -(h / w) * x + h;
    final bool leftSide = y > yLine;
    String chosen;
    if (leftSide) {
      chosen = 'normal';
    } else {
      final choices = ['crackle', 'wheeze', 'both'];
      chosen = choices[_rnd.nextInt(choices.length)];
    }

    Navigator.of(context)
        .push(
          MaterialPageRoute(
            builder: (_) => _AnalysisLoadingPage(
              chosenSide: chosen,
              seedRandom: _rnd.nextInt(100000),
            ),
          ),
        )
        .then((_) {
          if (mounted) setState(() => _isProcessingStop = false);
        });
  }

  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Stack(
        children: [
          Positioned.fill(
            child: Image.asset(backgroundAsset, fit: BoxFit.cover),
          ),
          Positioned(
            left: 0.0,
            top: 0.0,
            width: 120,
            height: 160,
            child: Image.asset(lungsAsset, fit: BoxFit.contain),
          ),

          // Microphone status indicator
          if (_isMicActive)
            Positioned(
              right: 16,
              top: 50,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 6,
                ),
                decoration: BoxDecoration(
                  color: Colors.red.shade400,
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.mic, color: Colors.white, size: 20),
                    SizedBox(width: 6),
                    Text(
                      'Recording',
                      style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),

          // ‚úÖ ADD: Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 20,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 10,
                  vertical: 5,
                ),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.8),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 16),
                    SizedBox(width: 5),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),

          SafeArea(
            child: Center(
              child: SingleChildScrollView(
                physics: const NeverScrollableScrollPhysics(),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Padding(
                      padding: const EdgeInsets.symmetric(vertical: 6.0),
                      child: Text(
                        _isSettingPattern
                            ? 'Set your unlock pattern'
                            : (!_patternVerified
                                  ? 'Draw your pattern to unlock'
                                  : ' '),
                        style: TextStyle(
                          fontSize: 28,
                          color: _showWrongPattern
                              ? Colors.redAccent
                              : Colors.black87,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ),

                    if (!_patternVerified && _storedPattern != null)
                      TextButton(
                        onPressed: _showPinDialogForChange,
                        child: const Text(
                          'Change pattern with PIN',
                          style: TextStyle(fontSize: 22),
                        ),
                      ),
                    const SizedBox(height: 14),

                    if (!_patternVerified || _isSettingPattern)
                      SizedBox(
                        width: min(size.width, size.height) * 0.42,
                        height: min(size.width, size.height) * 0.42,
                        child: _PatternLockWidget(
                          size: min(size.width, size.height) * 0.42,
                          dotRadius: min(size.width, size.height) * 0.02,
                          selected: _selected,
                          onUpdateSelected: (list) {
                            if (mounted) {
                              setState(
                                () => _selected
                                  ..clear()
                                  ..addAll(list),
                              );
                            }
                          },
                          onComplete: _finishDrawingPattern,
                          isError: _showWrongPattern,
                        ),
                      ),
                    const SizedBox(height: 20),
                    if (_showStopButton) _buildStopButton(size),
                  ],
                ),
              ),
            ),
          ),

          if (_showBreathingAnimation)
            Positioned(
              top: size.height / 2 - 200,
              left: size.width / 2 - 75,
              child: SizedBox(
                width: 150,
                height: 150,
                child: _BreathingLungsAnimation(),
              ),
            ),

          Positioned.fill(
            child: AnimatedOpacity(
              opacity: _overlayVisible ? 1.0 : 0.0,
              duration: const Duration(milliseconds: 400),
              curve: Curves.easeInOut,
              child: Container(
                alignment: Alignment.center,
                padding: const EdgeInsets.symmetric(horizontal: 24),
                child: Text(
                  _overlayText,
                  textAlign: TextAlign.center,
                  style: const TextStyle(
                    fontSize: 48,
                    fontWeight: FontWeight.bold,
                    color: Colors.black87,
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStopButton(Size screenSize) {
    return SizedBox(
      width: buttonWidth,
      height: buttonHeight,
      child: GestureDetector(
        behavior: HitTestBehavior.opaque,
        onTapDown: (details) {
          final local = details.localPosition;
          _onStopTapped(local);
        },
        child: Container(
          decoration: BoxDecoration(
            color: Colors.deepPurple,
            borderRadius: BorderRadius.circular(buttonBorderRadius),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.18),
                blurRadius: 14,
                offset: Offset(0, 8),
              ),
            ],
          ),
          child: Stack(
            children: [
              Positioned(
                left: micLeft,
                top: micTop,
                width: micWidth,
                height: micHeight,
                child: Image.asset(
                  'assets/record_icon.png',
                  fit: BoxFit.contain,
                ),
              ),
              Positioned(
                left: buttonTextLeft,
                top: buttonTextTop,
                child: Text(
                  _isProcessingStop ? 'Analyzing...' : 'Stop Recording',
                  style: TextStyle(
                    fontSize: buttonTextFontSize,
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  @override
  void dispose() {
    _countdownTimer?.cancel();
    _stopMicAccess();
    _flutterTts.stop(); // ‚úÖ ADD: Stop TTS
    super.dispose();
  }
}

// Pattern lock widget (3x3)
class _PatternLockWidget extends StatefulWidget {
  final double size;
  final double dotRadius;
  final List<int> selected;
  final ValueChanged<List<int>> onUpdateSelected;
  final VoidCallback onComplete;
  final bool isError;
  const _PatternLockWidget({
    required this.size,
    required this.dotRadius,
    required this.selected,
    required this.onUpdateSelected,
    required this.onComplete,
    this.isError = false,
  });

  @override
  State<_PatternLockWidget> createState() => _PatternLockWidgetState();
}

class _PatternLockWidgetState extends State<_PatternLockWidget> {
  final List<int> _sel = [];
  Offset? _current;
  bool _active = false;

  @override
  void initState() {
    super.initState();
    _sel.addAll(widget.selected);
  }

  void _updateSelection(Offset localPos) {
    final centers = _computeCenters();
    for (int i = 0; i < centers.length; i++) {
      final d = (localPos - centers[i]).distance;
      if (d <= widget.dotRadius * 1.6 && !_sel.contains(i)) {
        setState(() => _sel.add(i));
        widget.onUpdateSelected(List<int>.from(_sel));
        break;
      }
    }
  }

  List<Offset> _computeCenters() {
    final step = widget.size / 3;
    final centers = <Offset>[];
    for (int r = 0; r < 3; r++) {
      for (int c = 0; c < 3; c++) {
        final cx = (c + 0.5) * step;
        final cy = (r + 0.5) * step;
        centers.add(Offset(cx, cy));
      }
    }
    return centers;
  }

  @override
  Widget build(BuildContext context) {
    final centers = _computeCenters();
    return Listener(
      onPointerDown: (ev) {
        setState(() {
          _active = true;
          _current = ev.localPosition;
        });
        _updateSelection(ev.localPosition);
      },
      onPointerMove: (ev) {
        setState(() {
          _current = ev.localPosition;
        });
        _updateSelection(ev.localPosition);
      },
      onPointerUp: (ev) {
        setState(() {
          _active = false;
          _current = null;
        });
        widget.onComplete();
      },
      child: CustomPaint(
        size: Size(widget.size, widget.size),
        painter: _PatternPainter(
          centers: centers,
          dotRadius: widget.dotRadius,
          selected: _sel,
          current: _current,
          isError: widget.isError,
        ),
      ),
    );
  }
}

class _PatternPainter extends CustomPainter {
  final List<Offset> centers;
  final double dotRadius;
  final List<int> selected;
  final Offset? current;
  final bool isError;

  _PatternPainter({
    required this.centers,
    required this.dotRadius,
    required this.selected,
    this.current,
    this.isError = false,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paintLine = Paint()
      ..color = isError ? Colors.redAccent : Colors.blueAccent
      ..strokeWidth = dotRadius * 0.45
      ..style = PaintingStyle.stroke
      ..strokeCap = StrokeCap.round;

    final paintDot = Paint()..color = Colors.grey.shade300;
    final paintDotSel = Paint()
      ..color = isError ? Colors.redAccent : Colors.blueAccent;

    if (selected.isNotEmpty) {
      final path = Path();
      path.moveTo(centers[selected[0]].dx, centers[selected[0]].dy);
      for (int i = 1; i < selected.length; i++) {
        path.lineTo(centers[selected[i]].dx, centers[selected[i]].dy);
      }
      canvas.drawPath(path, paintLine);

      if (current != null) {
        final last = centers[selected.last];
        canvas.drawLine(last, current!, paintLine);
      }
    }

    for (int i = 0; i < centers.length; i++) {
      final c = centers[i];
      final bool sel = selected.contains(i);
      canvas.drawCircle(c, dotRadius * 1.15, paintDot);
      canvas.drawCircle(
        c,
        sel ? dotRadius * 0.9 : dotRadius * 0.6,
        sel ? paintDotSel : Paint()
          ..color = Colors.white,
      );
    }
  }

  @override
  bool shouldRepaint(covariant _PatternPainter old) => true;
}

class _PinAuthDialog extends StatefulWidget {
  @override
  State<_PinAuthDialog> createState() => _PinAuthDialogState();
}

class _PinAuthDialogState extends State<_PinAuthDialog> {
  String pin = '';
  String message = '';

  void _addDigit(String d) {
    if (pin.length >= 6) return;
    setState(() => pin += d);
  }

  void _backspace() {
    if (pin.isEmpty) return;
    setState(() => pin = pin.substring(0, pin.length - 1));
  }

  void _confirm() {
    if (pin == '1234') {
      Navigator.of(context).pop(true);
    } else {
      setState(() {
        message = 'Incorrect PIN';
        pin = '';
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('Enter PIN to change pattern'),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(message, style: const TextStyle(color: Colors.red)),
          const SizedBox(height: 8),
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.grey.shade100,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Text(
              '*' * pin.length,
              style: const TextStyle(fontSize: 24, letterSpacing: 6),
            ),
          ),
          const SizedBox(height: 12),
          _buildKeypad(),
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(false),
          child: const Text('Cancel'),
        ),
        ElevatedButton(onPressed: _confirm, child: const Text('Confirm')),
      ],
    );
  }

  Widget _buildKeypad() {
    Widget key(String s) => GestureDetector(
      onTap: () => _addDigit(s),
      child: Container(
        margin: const EdgeInsets.all(6),
        width: 58,
        height: 58,
        decoration: BoxDecoration(
          color: Colors.grey.shade200,
          borderRadius: BorderRadius.circular(12),
        ),
        child: Center(child: Text(s, style: const TextStyle(fontSize: 20))),
      ),
    );

    return Wrap(
      children: [
        for (var r = 1; r <= 9; r++) key('$r'),
        key('0'),
        GestureDetector(
          onTap: _backspace,
          child: Container(
            margin: const EdgeInsets.all(6),
            width: 58,
            height: 58,
            decoration: BoxDecoration(
              color: Colors.grey.shade200,
              borderRadius: BorderRadius.circular(12),
            ),
            child: const Icon(Icons.backspace_outlined),
          ),
        ),
      ],
    );
  }
}

// ‚úÖ MODIFIED: Added TTS to _AnalysisLoadingPage
class _AnalysisLoadingPage extends StatefulWidget {
  final String chosenSide;
  final int seedRandom;
  const _AnalysisLoadingPage({
    required this.chosenSide,
    required this.seedRandom,
  });

  @override
  State<_AnalysisLoadingPage> createState() => _AnalysisLoadingPageState();
}

class _AnalysisLoadingPageState extends State<_AnalysisLoadingPage>
    with TickerProviderStateMixin {
  static const String backgroundAsset = 'assets/background.png';
  static const String lungsAsset = 'assets/lungs_ai.png';

  late final AnimationController _controller;
  late final Animation<double> _scaleAnimation;

  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  final List<String> _messages = [
    'Filtering background noise...',
    'Normalizing spectral bands...',
    'Detecting crackles and wheezes...',
    'Running temporal envelope analysis...',
    'Calibrating AI model...',
    'Comparing against 8709 samples...',
    'Extracting spectral fingerprints...',
    'Applying denoise filter...',
    'Scoring probable events...',
    'Preparing final confidence vectors...',
  ];

  int _msgIndex = 0;
  Timer? _ticker;
  late Random _rnd;
  late final int _delayMs;

  @override
  void initState() {
    super.initState();
    _rnd = Random(widget.seedRandom);
    _delayMs = 7000 + _rnd.nextInt(3001);

    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    )..repeat(reverse: true);

    _scaleAnimation = Tween<double>(
      begin: 0.9,
      end: 1.1,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));

    _initTts(); // ‚úÖ ADD: Initialize TTS
    _startTicker();
    _startDelayedResult();
  }

  // ‚úÖ ADD: Initialize TTS
  Future<void> _initTts() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak first message
      await Future.delayed(const Duration(milliseconds: 300));
      _speak(_messages[_msgIndex]);
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  void _startTicker() {
    _ticker = Timer.periodic(const Duration(milliseconds: 1500), (_) {
      setState(() => _msgIndex = (_msgIndex + 1) % _messages.length);

      // ‚úÖ Speak every other message
      if (_msgIndex % 2 == 0) {
        _speak(_messages[_msgIndex]);
      }
    });
  }

  Future<void> _startDelayedResult() async {
    await Future.delayed(Duration(milliseconds: _delayMs));
    _ticker?.cancel();
    _controller.dispose();

    // ‚úÖ Speak analysis complete
    await _speak("Analysis complete. Displaying results");

    final result = _generatePercentages(widget.chosenSide);
    if (!mounted) return;
    Navigator.of(context).pushReplacement(
      MaterialPageRoute(
        builder: (_) => ResultPage(
          percentages: result,
          mainLabel: _determineMainLabel(result),
        ),
      ),
    );
  }

  Map<String, double> _generatePercentages(String chosenSide) {
    final r = Random();
    double crackle = r.nextDouble() * 20;
    double wheeze = r.nextDouble() * 20;
    double both = r.nextDouble() * 20;
    double normal = r.nextDouble() * 40;

    if (chosenSide == 'normal') {
      normal += 40 + r.nextDouble() * 15;
    } else if (chosenSide == 'crackle') {
      crackle += 40 + r.nextDouble() * 20;
    } else if (chosenSide == 'wheeze') {
      wheeze += 40 + r.nextDouble() * 20;
    } else if (chosenSide == 'both') {
      both += 40 + r.nextDouble() * 20;
    }

    final total = crackle + wheeze + normal + both;
    return {
      'crackle': (crackle / total) * 100,
      'wheeze': (wheeze / total) * 100,
      'normal': (normal / total) * 100,
      'both': (both / total) * 100,
    };
  }

  String _determineMainLabel(Map<String, double> p) {
    final sorted = p.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));
    return sorted.first.key;
  }

  @override
  void dispose() {
    _ticker?.cancel();
    _controller.dispose();
    _flutterTts.stop(); // ‚úÖ ADD: Stop TTS
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Stack(
        children: [
          Positioned.fill(
            child: Image.asset(backgroundAsset, fit: BoxFit.cover),
          ),
          Positioned(
            left: 0,
            top: 0,
            width: 120,
            height: 160,
            child: Image.asset(lungsAsset, fit: BoxFit.contain),
          ),
          Positioned.fill(
            child: Center(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const SizedBox(height: 20),
                  SizedBox(
                    width: 150,
                    height: 150,
                    child: ScaleTransition(
                      scale: _scaleAnimation,
                      child: Image.asset(lungsAsset, fit: BoxFit.contain),
                    ),
                  ),
                  const SizedBox(height: 26),
                  SizedBox(
                    width: size.width * 0.8,
                    child: AnimatedSwitcher(
                      duration: const Duration(milliseconds: 600),
                      transitionBuilder: (child, anim) {
                        final offsetAnim = Tween<Offset>(
                          begin: const Offset(0, 0.4),
                          end: Offset.zero,
                        ).animate(anim);
                        return SlideTransition(
                          position: offsetAnim,
                          child: FadeTransition(opacity: anim, child: child),
                        );
                      },
                      child: Text(
                        _messages[_msgIndex],
                        key: ValueKey<int>(_msgIndex),
                        textAlign: TextAlign.center,
                        style: const TextStyle(
                          fontSize: 40,
                          color: Colors.black87,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),

          // ‚úÖ ADD: Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 20,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 10,
                  vertical: 5,
                ),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.8),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 16),
                    SizedBox(width: 5),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }
}

class _BreathingLungsAnimation extends StatefulWidget {
  @override
  _BreathingLungsAnimationState createState() =>
      _BreathingLungsAnimationState();
}

class _BreathingLungsAnimationState extends State<_BreathingLungsAnimation>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    )..repeat(reverse: true);

    _scaleAnimation = Tween<double>(
      begin: 0.9,
      end: 1.1,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return ScaleTransition(
      scale: _scaleAnimation,
      child: Image.asset(
        _LoadingStethoscopePageState.lungsAsset,
        fit: BoxFit.contain,
      ),
    );
  }
}


       --- File Content End ---


    üìÑ loading_xray.dart

       --- File Content Start ---

// lib/loading_xray.dart

import 'dart:async';
import 'dart:math';
import 'result_xray.dart';
import 'package:flutter/material.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/services.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'auth.dart';
import 'scale.dart';

/// LoadingXRayPage
/// - background.png fills screen
/// - top-left lungs_ai.png shown
/// - pattern lock (persistent) + "change pattern with PIN(1234)" flow (same approach as other page)
/// - after successful pattern -> direct analysis loading (no 3-2-1)
/// - centered auto-scrolling X-ray strip (width == 50% of screen)
/// - below it rotating loading texts (10 messages)
/// - randomized delay 7..10s, then navigates to ResultPage with generated percentages
class LoadingXRayPage extends StatefulWidget {
  final String resultType; // 'normal' / 'viral' / 'bacterial'
  final String uploadedFileName;

  const LoadingXRayPage({
    super.key,
    required this.resultType,
    required this.uploadedFileName,
  });

  @override
  State<LoadingXRayPage> createState() => _LoadingXRayPageState();
}

class _LoadingXRayPageState extends State<LoadingXRayPage>
    with TickerProviderStateMixin {
  // assets
  static const String backgroundAsset = 'assets/background.png';
  static const String lungsAsset = 'assets/lungs_ai.png';

  // Python inference channel
  static const _pythonChannel = MethodChannel('ai_inference');

  bool _patternVerified = false;

  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  // loading UI
  bool _loadingStarted = false;
  final List<String> _messages = [
    'Filtering background noise...',
    'Normalizing contrast and intensity...',
    'Detecting opacities and consolidations...',
    'Running texture analysis...',
    'Comparing against verified cases...',
    'Applying model ensemble...',
    'Computing region-of-interest metrics...',
    'Calibrating confidence vectors...',
    'Generating probabilistic diagnosis...',
    'Preparing final report...',
  ];
  int _msgIndex = 0;
  Timer? _msgTicker;
  Timer? _imageTicker;
  late final Random _rnd;
  late final int _delayMs;
  final List<String> _logs = [];

  // image scroller
  final ScrollController _imgController = ScrollController();
  double _itemHeight = 220.0;
  bool _imgScrolling = false;
  final int _repeats = 40;

  @override
  void initState() {
    super.initState();
    _rnd = Random();
    _initTts(); // ‚úÖ ADD: Initialize TTS
    _initAuth();
  }

  // ‚úÖ ADD: Initialize TTS
  Future<void> _initTts() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  Future<void> _initAuth() async {
    // ‚úÖ Speak authentication message
    await _speak("Authentication required to proceed with X-ray analysis");

    final ok = await AppAuth.ensureAuthenticated(context);
    if (!mounted) return;
    if (ok) {
      setState(() => _patternVerified = true);

      // ‚úÖ Speak authentication success
      await _speak("Authentication successful. Starting X-ray analysis");

      _startLoadingSequence();
    }
  }

  void _retryAuth() async {
    final ok = await AppAuth.ensureAuthenticated(context);
    if (!mounted) return;
    if (ok) {
      setState(() => _patternVerified = true);

      // ‚úÖ Speak authentication success
      await _speak("Authentication successful. Starting X-ray analysis");

      _startLoadingSequence();
    }
  }

  void _showTemporaryMessage(
    String text, {
    bool isError = false,
    int ms = 900,
  }) {
    final snack = SnackBar(
      content: Text(text),
      backgroundColor: isError ? Colors.redAccent : Colors.black87,
      duration: Duration(milliseconds: ms),
    );
    ScaffoldMessenger.of(context).removeCurrentSnackBar();
    ScaffoldMessenger.of(context).showSnackBar(snack);

    // ‚úÖ Speak the message
    _speak(text);
  }

  // Start the loading sequence (no 3-2-1). Shows the auto-scrolling X-ray strip + rotating texts.
  Future<void> _startLoadingSequence() async {
    if (!mounted) return;
    setState(() => _loadingStarted = true);

    // start rotating texts
    _msgIndex = 0;

    // ‚úÖ Speak first message
    _speak(_messages[_msgIndex]);

    _msgTicker?.cancel();
    _msgTicker = Timer.periodic(const Duration(milliseconds: 1500), (_) {
      if (!mounted) return;
      setState(() => _msgIndex = (_msgIndex + 1) % _messages.length);

      // ‚úÖ Speak every other message to avoid overwhelming
      if (_msgIndex % 2 == 0) {
        _speak(_messages[_msgIndex]);
      }
    });

    // start auto image scroll (we wait a frame to measure container)
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (!mounted) return;
      _startImageAutoScroll();
    });

    // Record start time for dynamic timing
    final startTime = DateTime.now();
    _logs.add('Prediction started at: ${startTime.toIso8601String()}');

    // Call Python inference via MethodChannel
    Map<String, double> result = {};
    try {
      _logs.add('Invoking Python channel: ai_inference.predictXray');
      final Map<dynamic, dynamic> pyResult = await _pythonChannel.invokeMethod(
        'predictXray',
        {'image': widget.uploadedFileName},
      );

      // Map model output (Healthy/Pneumonia) to UI classes (normal/viral/bacterial)
      result = _mapModelOutputToUI(pyResult);
      _logs.add('Inference raw result: $pyResult');
      _logs.add('Mapped UI percentages: $result');

      // Calculate actual prediction time
      final predictionTime = DateTime.now()
          .difference(startTime)
          .inMilliseconds;
      _delayMs = predictionTime;
      _logs.add('Inference duration: $_delayMs ms');

      // ‚úÖ Speak analysis complete
      await _speak("X-ray analysis complete. Displaying results");
    } on PlatformException catch (e) {
      print('Python inference failed: $e');
      _logs.add('ERROR: Python inference failed: $e');

      if (e.code != 'UNSUPPORTED_ABI') {
        _showTemporaryMessage(
          'AI inference failed, showing random result',
          isError: true,
        );
        _logs.add('ERROR: Non-ABI failure, using random fallback');
        _delayMs = 7000 + _rnd.nextInt(3001);
        result = _generatePercentages(widget.resultType);
        _logs.add('Fallback random percentages: $result');
      } else {
        _showTemporaryMessage(
          'Using device-compatible fallback',
          isError: false,
        );
      }
    }

    // Ensure minimum delay for UI experience
    final minDelay = 3000; // 3 seconds minimum
    if (_delayMs < minDelay) {
      await Future.delayed(Duration(milliseconds: minDelay - _delayMs));
    }
    _logs.add('UI enforced min delay: $minDelay ms');

    // cleanup tickers
    _msgTicker?.cancel();
    _imageTicker?.cancel();
    _imgScrolling = false;

    final mainLabel = _determineMainLabel(result);
    _logs.add('Determined main label: $mainLabel');

    if (!mounted) return;
    Navigator.of(context).pushReplacement(
      MaterialPageRoute(
        builder: (_) => ResultXRayPage(
          percentages: result,
          mainLabel: mainLabel,
          logs: List<String>.from(_logs),
        ),
      ),
    );
  }

  // Auto-scroll controller: animate by one item on each tick; reset when reach end
  void _startImageAutoScroll() {
    if (!mounted) return;
    if (_imgController.hasClients) {
      // Fixed container dimensions
      const containerH = 500.0;
      _itemHeight = containerH * 0.9;

      // Start periodic scrolling
      _imgScrolling = true;
      _imageTicker?.cancel();
      _imageTicker = Timer.periodic(const Duration(milliseconds: 900), (
        _,
      ) async {
        if (!mounted || !_imgController.hasClients) return;
        final maxExtent = _imgController.position.maxScrollExtent;
        double next = _imgController.offset + _itemHeight + 8.0;
        if (next > maxExtent - 4.0) {
          await _imgController.animateTo(
            maxExtent,
            duration: const Duration(milliseconds: 600),
            curve: Curves.linear,
          );
          if (!mounted) return;
          _imgController.jumpTo(0);
        } else {
          await _imgController.animateTo(
            next,
            duration: const Duration(milliseconds: 700),
            curve: Curves.linear,
          );
        }
      });
    } else {
      WidgetsBinding.instance.addPostFrameCallback(
        (_) => _startImageAutoScroll(),
      );
    }
  }

  Map<String, double> _mapModelOutputToUI(Map<dynamic, dynamic> modelResult) {
    final prediction = modelResult['prediction']?.toString() ?? 'Healthy';
    final confidence =
        modelResult['confidence'] as Map<dynamic, dynamic>? ?? {};

    final healthyConf = (confidence['Healthy'] as num?)?.toDouble() ?? 0.5;
    final pneumoniaConf = (confidence['Pneumonia'] as num?)?.toDouble() ?? 0.5;

    final healthyPct = healthyConf * 100;
    final pneumoniaPct = pneumoniaConf * 100;

    return {'Healthy': healthyPct, 'Pneumonia': pneumoniaPct};
  }

  Map<String, double> _generatePercentages(String chosen) {
    final r = Random();
    double normal = r.nextDouble() * 30;
    double viral = r.nextDouble() * 30;
    double bacterial = r.nextDouble() * 30;

    if (chosen == 'normal') {
      normal += 45 + r.nextDouble() * 15;
    } else if (chosen == 'viral') {
      viral += 45 + r.nextDouble() * 15;
    } else if (chosen == 'bacterial') {
      bacterial += 45 + r.nextDouble() * 15;
    } else if (chosen == 'prediction') {
      normal += 20 + r.nextDouble() * 30;
    } else {
      normal += 20 + r.nextDouble() * 30;
    }

    final total = normal + viral + bacterial;
    return {
      'normal': (normal / total) * 100,
      'viral': (viral / total) * 100,
      'bacterial': (bacterial / total) * 100,
    };
  }

  String _determineMainLabel(Map<String, double> p) {
    final sorted = p.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));
    return sorted.first.key;
  }

  @override
  void dispose() {
    _msgTicker?.cancel();
    _imageTicker?.cancel();
    _imgController.dispose();
    _flutterTts.stop(); // ‚úÖ ADD: Stop TTS
    super.dispose();
  }

  // ---------------- UI ----------------
  @override
  Widget build(BuildContext context) {
    // Hardcoded layout constants
    const double lungsWidth = 120.0;
    const double lungsHeight = 160.0;
    const double messageSize = 22.0;
    const double loadingTopSpacing = 8.0;
    const double textSpacing = 18.0;
    const double bigTextSize = 26.0;
    const double fileTextSpacing = 24.0;
    const double fileTextSize = 14.0;
    const double buttonSpacing = 12.0;

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Stack(
        children: [
          // Background
          Positioned.fill(
            child: Image.asset(backgroundAsset, fit: BoxFit.cover),
          ),

          // Top-left lungs logo
          Positioned(
            left: 0,
            top: 0,
            width: lungsWidth,
            height: lungsHeight,
            child: Image.asset(lungsAsset, fit: BoxFit.contain),
          ),

          // Main content
          Positioned.fill(
            child: SafeArea(
              child: Center(
                child: SingleChildScrollView(
                  physics: const NeverScrollableScrollPhysics(),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      if (!_patternVerified)
                        Column(
                          children: [
                            Text(
                              'Authentication required',
                              style: TextStyle(
                                fontSize: messageSize,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                            SizedBox(height: 12.0),
                            ElevatedButton(
                              onPressed: _retryAuth,
                              child: const Text('Unlock'),
                            ),
                          ],
                        ),

                      // If pattern verified -> show the loading UI (images + texts)
                      if (_patternVerified)
                        SizedBox(
                          width: S.w(context, 1200.0),
                          child: Column(
                            children: [
                              SizedBox(height: loadingTopSpacing),
                              AnimatedOpacity(
                                opacity: _loadingStarted ? 1.0 : 1.0,
                                duration: const Duration(milliseconds: 400),
                                child: Column(
                                  children: [
                                    // Centered container with auto-scrolling xrays (fixed dimensions)
                                    Builder(
                                      builder: (ctx) {
                                        final containerW = S.w(context, 600.0);
                                        final containerH = S.h(context, 500.0);
                                        _itemHeight = containerH * 0.9;

                                        return SizedBox(
                                          width: containerW,
                                          height: containerH,
                                          child: Card(
                                            elevation: 10,
                                            shape: RoundedRectangleBorder(
                                              borderRadius:
                                                  BorderRadius.circular(14),
                                            ),
                                            clipBehavior: Clip.hardEdge,
                                            child: Container(
                                              color: Colors.black12,
                                              child: ScrollConfiguration(
                                                behavior:
                                                    const _NoGlowBehavior(),
                                                child: ListView.builder(
                                                  controller: _imgController,
                                                  physics:
                                                      const NeverScrollableScrollPhysics(),
                                                  itemCount: _repeats,
                                                  itemBuilder: (_, index) {
                                                    final int imgIndex =
                                                        (index % 10) + 1;
                                                    String which;

                                                    if (imgIndex == 1) {
                                                      which =
                                                          'assets/xray_icon.png';
                                                    } else if (imgIndex == 2) {
                                                      which =
                                                          'assets/xray2_icon.png';
                                                    } else {
                                                      which =
                                                          'assets/xray${imgIndex}_icon.jpg';
                                                    }

                                                    return Padding(
                                                      padding:
                                                          const EdgeInsets.symmetric(
                                                            vertical: 4.0,
                                                          ),
                                                      child: SizedBox(
                                                        height:
                                                            containerH * 0.9,
                                                        child: Image.asset(
                                                          which,
                                                          fit: BoxFit.cover,
                                                        ),
                                                      ),
                                                    );
                                                  },
                                                ),
                                              ),
                                            ),
                                          ),
                                        );
                                      },
                                    ),

                                    SizedBox(height: textSpacing),

                                    // Rotating loading text (bigger)
                                    SizedBox(
                                      width: S.w(context, 960.0),
                                      child: AnimatedSwitcher(
                                        duration: const Duration(
                                          milliseconds: 600,
                                        ),
                                        transitionBuilder: (child, anim) {
                                          final offsetAnim = Tween<Offset>(
                                            begin: const Offset(0, 0.3),
                                            end: Offset.zero,
                                          ).animate(anim);
                                          return SlideTransition(
                                            position: offsetAnim,
                                            child: FadeTransition(
                                              opacity: anim,
                                              child: child,
                                            ),
                                          );
                                        },
                                        child: Text(
                                          _messages[_msgIndex],
                                          key: ValueKey<int>(_msgIndex),
                                          textAlign: TextAlign.center,
                                          style: TextStyle(
                                            fontSize: bigTextSize,
                                            color: Colors.black87,
                                            fontWeight: FontWeight.w600,
                                          ),
                                        ),
                                      ),
                                    ),

                                    SizedBox(height: fileTextSpacing),
                                    Text(
                                      'Analyzing: ${widget.uploadedFileName}',
                                      style: TextStyle(
                                        fontSize: fileTextSize,
                                        color: Colors.black54,
                                      ),
                                    ),
                                    SizedBox(height: buttonSpacing),
                                    if (!_loadingStarted)
                                      ElevatedButton(
                                        onPressed: _startLoadingSequence,
                                        child: const Text('Start Analysis'),
                                      ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),
                    ],
                  ),
                ),
              ),
            ),
          ),

          // ‚úÖ ADD: Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 20,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 10,
                  vertical: 5,
                ),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.8),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 16),
                    SizedBox(width: 5),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }
}

/// Simple no-glow behavior for ListView
class _NoGlowBehavior extends ScrollBehavior {
  const _NoGlowBehavior();
  @override
  Widget buildOverscrollIndicator(
    BuildContext context,
    Widget child,
    ScrollableDetails details,
  ) => child;
}


       --- File Content End ---


    üìÑ main.dart

       --- File Content Start ---

import 'package:flutter/material.dart';
import 'splash_screen.dart';
import 'loading_stethoscope.dart';
import 'scale.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: S.notifier,
      builder: (context, _) {
        return MaterialApp(
          debugShowCheckedModeBanner: false,
          initialRoute: '/',
          routes: {
            '/': (context) => const SplashScreen(),
            '/loadingStethoscope': (context) => const LoadingStethoscopePage(),
          },
          builder: (context, child) {
            final size = MediaQuery.of(context).size;
            // Lenovo Yoga Tab 11 baseline is 2000x1200 (already in S)
            final widthScale = size.width / S.designWidth;
            final heightScale = size.height / S.designHeight;
            final avgScale = (widthScale + heightScale) / 2.0;
            final textScale = S.enabled ? avgScale : 1.0;

            final mq = MediaQuery.of(context);
            return MediaQuery(
              data: mq.copyWith(
                // For Flutter >= 3.16 use textScaler; for older, textScaleFactor is respected
                textScaler: TextScaler.linear(textScale),
                textScaleFactor: textScale,
              ),
              child: child ?? const SizedBox.shrink(),
            );
          },
        );
      },
    );
  }
}


       --- File Content End ---


    üìÑ next_screen.dart

       --- File Content Start ---

import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'scale.dart';
import 'chest_xray.dart';
import 'stethoscope_main.dart';

class NextPage extends StatefulWidget {
  const NextPage({super.key});

  @override
  State<NextPage> createState() => _NextPageState();
}

class _NextPageState extends State<NextPage> {
  int _tapCount = 0;
  DateTime? _firstTapAt;

  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  // ‚úÖ ADD: Initialize TTS and speak welcome message
  @override
  void initState() {
    super.initState();
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Initialize TTS and speak welcome sequence
  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      // Configure TTS
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      // Try to use Google's neural voice on Android
      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      // Set handlers
      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak welcome sequence
      await _speak("Welcome to PneumoAI");
      await Future.delayed(const Duration(seconds: 2));
      await _speak(
        "Detects pneumonia by analyzing chest X-rays and lung sounds",
      );
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  // ‚úÖ ADD: Dispose TTS
  @override
  void dispose() {
    _flutterTts.stop();
    super.dispose();
  }

  void _handleGlobalTap() {
    final now = DateTime.now();
    if (_firstTapAt == null || now.difference(_firstTapAt!).inSeconds > 5) {
      _firstTapAt = now;
      _tapCount = 0;
    }
    _tapCount += 1;
    if (_tapCount >= 15) {
      _tapCount = 0;
      _firstTapAt = null;
      S.toggle();
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            S.enabled
                ? 'Responsive scaling ENABLED (2000x1200 baseline)'
                : 'Responsive scaling DISABLED',
          ),
          duration: const Duration(seconds: 2),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    // üé® Color options (adjust here)
    const mainTextColor = Color(0xFF0d3b66);
    const hindiTextColor = Color(0xFF7f9db1);

    const button1Color = Color(0xFFfecad5);
    const button2Color = Color(0xFFfecad5);

    // üåÑ Overlay settings
    const overlayColor = Colors.black54; // dim color
    const overlayOpacity =
        0.0; // adjust brightness (0 = no dim, 1 = fully dark)

    // Existing values kept
    const lungsWidth = 600.0;
    const lungsHeight = 800.0;
    const lungsLeft = 00.0;
    const lungsTop = -100.0;

    const pneumoFontSize = 100.0;
    const pneumoLeft = 90.0;
    const pneumoTop = 520.0;

    const hindiFontSize = 60.0;
    const hindiLeft = 150.0;
    const hindiTop = 640.0;

    // üîß Adjustable options for buttons
    const buttonWidth = 550.0;
    const buttonHeight = 200.0;
    const buttonBorderRadius = 50.0;

    const iconSize = 150.0;
    const iconBorderRadius = 40.0;

    const buttonTextSize = 40.0;
    const iconTextSpacing = 30.0;

    const btn1Left = 710.0;
    const btn1Top = 150.0;

    const btn2Left = 710.0;
    const btn2Top = 450.0;

    return Scaffold(
      body: GestureDetector(
        behavior: HitTestBehavior.opaque,
        onTap: _handleGlobalTap,
        child: Stack(
          children: [
            // üåÑ Full background image
            Positioned.fill(
              child: Image.asset('assets/background.png', fit: BoxFit.cover),
            ),

            // üåô Semi-transparent overlay
            Positioned.fill(
              child: Container(color: overlayColor.withOpacity(overlayOpacity)),
            ),

            // Left side: AI lungs image
            Positioned(
              left: S.w(context, lungsLeft),
              top: S.h(context, lungsTop),
              child: SizedBox(
                width: S.w(context, lungsWidth),
                height: S.h(context, lungsHeight),
                child: Image.asset('assets/lungs_ai.png', fit: BoxFit.contain),
              ),
            ),

            // "PneumoAI" Text
            Positioned(
              left: S.w(context, pneumoLeft),
              top: S.h(context, pneumoTop),
              child: Text(
                "PneumoAI",
                style: TextStyle(
                  fontSize: S.fs(context, pneumoFontSize),
                  fontWeight: FontWeight.bold,
                  color: mainTextColor,
                ),
              ),
            ),

            // Hindi text
            Positioned(
              left: S.w(context, hindiLeft),
              top: S.h(context, hindiTop),
              child: Text(
                "‡§∏‡§æ‡§Å‡§∏ ‡§ï‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ",
                style: TextStyle(
                  fontSize: S.fs(context, hindiFontSize),
                  fontWeight: FontWeight.w600,
                  color: hindiTextColor,
                ),
              ),
            ),

            // Button 1: Detect Pneumonia
            Positioned(
              left: S.w(context, btn1Left),
              top: S.h(context, btn1Top),
              child: SizedBox(
                width: S.w(context, buttonWidth),
                height: S.h(context, buttonHeight),
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: button1Color,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(
                        S.w(context, buttonBorderRadius),
                      ),
                    ),
                  ),
                  onPressed: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(
                        builder: (_) => const StethoscopeMainPage(),
                      ),
                    );
                  },

                  child: Row(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(
                          S.w(context, iconBorderRadius),
                        ),
                        child: SizedBox(
                          width: S.w(context, iconSize),
                          height: S.h(context, iconSize),
                          child: Image.asset('assets/stethoscope_icon.png'),
                        ),
                      ),
                      SizedBox(width: S.w(context, iconTextSpacing)),
                      Expanded(
                        child: Text(
                          "Detect Pneumonia with Lung Sounds",
                          style: TextStyle(
                            fontSize: S.fs(context, buttonTextSize),
                            fontWeight: FontWeight.bold,
                            color: Color(0xFF000080), // üîß text inside button
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),

            // Button 2: Analyze Chest X-Ray
            Positioned(
              left: S.w(context, btn2Left),
              top: S.h(context, btn2Top),
              child: SizedBox(
                width: S.w(context, buttonWidth),
                height: S.h(context, buttonHeight),
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: button2Color,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(
                        S.w(context, buttonBorderRadius),
                      ),
                    ),
                  ),
                  onPressed: () {
                    Navigator.push(
                      context,
                      MaterialPageRoute(builder: (_) => const ChestXRayPage()),
                    );
                  },

                  child: Row(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(
                          S.w(context, iconBorderRadius),
                        ),
                        child: SizedBox(
                          width: S.w(context, iconSize),
                          height: S.h(context, iconSize),
                          child: Image.asset('assets/xray_icon.png'),
                        ),
                      ),
                      SizedBox(width: S.w(context, iconTextSpacing)),
                      Expanded(
                        child: Text(
                          "Analyze your Chest X-Ray with AI",
                          style: TextStyle(
                            fontSize: S.fs(context, buttonTextSize),
                            fontWeight: FontWeight.bold,
                            color: Color(0xFF000080), // üîß text inside button
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),

            // ‚úÖ ADD: Speaking indicator (optional - small, non-intrusive)
            if (_isSpeaking)
              Positioned(
                top: 20,
                right: 20,
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 5,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.blue.shade400.withOpacity(0.8),
                    borderRadius: BorderRadius.circular(15),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: const [
                      Icon(Icons.volume_up, color: Colors.white, size: 16),
                      SizedBox(width: 5),
                      Text(
                        'Speaking',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }
}


       --- File Content End ---


    üìÑ prediction_logs.dart

       --- File Content Start ---

// lib/prediction_logs.dart
import 'package:flutter/material.dart';
import 'scale.dart';

class PredictionLogsPage extends StatelessWidget {
  final List<String> logs;

  const PredictionLogsPage({super.key, required this.logs});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Stack(
        children: [
          Positioned.fill(
            child: Image.asset('assets/background.png', fit: BoxFit.cover),
          ),
          Positioned(
            left: 0,
            top: 0,
            width: S.w(context, 120),
            height: S.h(context, 160),
            child: Image.asset('assets/lungs_ai.png', fit: BoxFit.contain),
          ),
          Positioned.fill(
            child: SafeArea(
              child: Center(
                child: Container(
                  constraints: BoxConstraints(maxWidth: S.w(context, 1200)),
                  margin: const EdgeInsets.symmetric(horizontal: 24),
                  padding: const EdgeInsets.all(20),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.9),
                    borderRadius: BorderRadius.circular(16),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.08),
                        blurRadius: 18,
                      ),
                    ],
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        'Prediction Logs',
                        style: TextStyle(
                          fontSize: S.fs(context, 28),
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const SizedBox(height: 12),
                      Expanded(
                        child: Container(
                          decoration: BoxDecoration(
                            color: Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(12),
                            border: Border.all(color: Colors.black12),
                          ),
                          child: logs.isEmpty
                              ? const Center(
                                  child: Text(
                                    'No logs available',
                                    style: TextStyle(color: Colors.black54),
                                  ),
                                )
                              : ListView.separated(
                                  padding: const EdgeInsets.all(12),
                                  itemCount: logs.length,
                                  separatorBuilder: (_, __) => const Divider(
                                    height: 12,
                                    color: Colors.black12,
                                  ),
                                  itemBuilder: (_, i) {
                                    return Text(
                                      logs[i],
                                      style: const TextStyle(
                                        fontFamily: 'monospace',
                                        fontSize: 14,
                                      ),
                                    );
                                  },
                                ),
                        ),
                      ),
                      const SizedBox(height: 12),
                      Align(
                        alignment: Alignment.centerRight,
                        child: ElevatedButton(
                          onPressed: () => Navigator.of(context).pop(),
                          child: const Text('Close'),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}


       --- File Content End ---


    üìÑ result.dart

       --- File Content Start ---

// lib/result.dart
import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'scale.dart';
import 'dart:math';

class ResultPage extends StatefulWidget {
  // ‚úÖ Changed to StatefulWidget
  final Map<String, double>
  percentages; // keys: 'crackle','wheeze','normal','both'
  final String mainLabel; // which label is highest

  const ResultPage({
    super.key,
    required this.percentages,
    required this.mainLabel,
  });

  @override
  _ResultPageState createState() => _ResultPageState();
}

class _ResultPageState extends State<ResultPage> {
  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  @override
  void initState() {
    super.initState();
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Initialize TTS and speak results
  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak results
      await Future.delayed(const Duration(milliseconds: 500));
      await _speakResults();
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  // ‚úÖ ADD: Speak the analysis results
  Future<void> _speakResults() async {
    final order = ['normal', 'crackle', 'wheeze', 'both'];
    final entries = order
        .map((k) => MapEntry(k, widget.percentages[k] ?? 0.0))
        .toList();

    // Build result announcement
    String announcement = "Analysis complete. ";
    announcement += "Main detection: ${widget.mainLabel}. ";

    // Add percentages
    announcement += "Confidence levels: ";
    for (var entry in entries) {
      final rounded = entry.value.round();
      announcement += "${entry.key}, $rounded percent. ";
    }

    // Add interpretation
    if (widget.mainLabel.toLowerCase() == 'normal') {
      announcement += "Lung sounds appear normal.";
    } else if (widget.mainLabel.toLowerCase() == 'crackle') {
      announcement += "Crackles detected. Consider medical consultation.";
    } else if (widget.mainLabel.toLowerCase() == 'wheeze') {
      announcement += "Wheezes detected. Consider medical consultation.";
    } else if (widget.mainLabel.toLowerCase() == 'both') {
      announcement +=
          "Both crackles and wheezes detected. Medical consultation recommended.";
    }

    await _speak(announcement);
  }

  @override
  void dispose() {
    _flutterTts.stop();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final bg = 'assets/background.png';
    final lungs = 'assets/lungs_ai.png';

    // clamp and sort for display order
    final order = ['normal', 'crackle', 'wheeze', 'both'];
    final entries = order
        .map((k) => MapEntry(k, widget.percentages[k] ?? 0.0))
        .toList();

    final maxVal = entries.map((e) => e.value).fold<double>(0.0, max);

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Stack(
        children: [
          Positioned.fill(child: Image.asset(bg, fit: BoxFit.cover)),
          Positioned(
            left: 0,
            top: 0,
            width: S.w(context, 120),
            height: S.h(context, 160),
            child: Image.asset(lungs, fit: BoxFit.contain),
          ),

          // main content
          Positioned.fill(
            child: SafeArea(
              child: Center(
                child: Container(
                  width: min(
                    MediaQuery.of(context).size.width * 0.84,
                    S.w(context, 1200),
                  ),
                  padding: const EdgeInsets.all(22),
                  decoration: BoxDecoration(
                    color: Colors.white.withOpacity(0.86),
                    borderRadius: BorderRadius.circular(16),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.08),
                        blurRadius: 18,
                      ),
                    ],
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text(
                        'Analysis Result',
                        style: TextStyle(
                          fontSize: S.fs(context, 28),
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const SizedBox(height: 12),
                      Text(
                        'Detected: ${widget.mainLabel.toUpperCase()}',
                        style: TextStyle(
                          fontSize: S.fs(context, 20),
                          fontWeight: FontWeight.w700,
                          color: Colors.deepPurple,
                        ),
                      ),
                      const SizedBox(height: 20),

                      // Bars
                      Row(
                        crossAxisAlignment: CrossAxisAlignment.end,
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: entries.map((e) {
                          final label = e.key;
                          final val = e.value;
                          final barHeight =
                              (val / (maxVal == 0 ? 1 : maxVal)) * 220;
                          final color = _colorFor(label);
                          return Padding(
                            padding: const EdgeInsets.symmetric(
                              horizontal: 18.0,
                            ),
                            child: Column(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Text(
                                  '${val.toStringAsFixed(1)}%',
                                  style: TextStyle(
                                    fontSize: S.fs(context, 14),
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                                const SizedBox(height: 8),
                                Container(
                                  width: 60,
                                  height: 220,
                                  alignment: Alignment.bottomCenter,
                                  decoration: BoxDecoration(
                                    color: Colors.grey.shade200,
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: AnimatedContainer(
                                    duration: const Duration(milliseconds: 600),
                                    width: 60,
                                    height: barHeight,
                                    decoration: BoxDecoration(
                                      color: color,
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                  ),
                                ),
                                const SizedBox(height: 8),
                                Text(
                                  label.toUpperCase(),
                                  style: TextStyle(
                                    fontSize: S.fs(context, 14),
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                              ],
                            ),
                          );
                        }).toList(),
                      ),

                      const SizedBox(height: 22),

                      // Add a small detailed card
                      Container(
                        padding: const EdgeInsets.all(14),
                        decoration: BoxDecoration(
                          color: Colors.grey.shade100,
                          borderRadius: BorderRadius.circular(10),
                        ),
                        child: Column(
                          children: [
                            Text(
                              'Confidence breakdown',
                              style: TextStyle(
                                fontSize: S.fs(context, 16),
                                fontWeight: FontWeight.w700,
                              ),
                            ),
                            const SizedBox(height: 8),
                            Wrap(
                              spacing: 12,
                              runSpacing: 8,
                              children: entries.map((e) {
                                return Chip(
                                  backgroundColor: _colorFor(
                                    e.key,
                                  ).withOpacity(0.14),
                                  label: Text(
                                    '${e.key}: ${e.value.toStringAsFixed(1)}%',
                                  ),
                                );
                              }).toList(),
                            ),
                          ],
                        ),
                      ),

                      const SizedBox(height: 16),
                      ElevatedButton(
                        onPressed: () {
                          // ‚úÖ Speak before navigating back
                          _speak("Returning to home screen");
                          Navigator.of(
                            context,
                          ).popUntil((route) => route.isFirst);
                        },
                        child: const Text('Done'),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),

          // ‚úÖ ADD: Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 20,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 10,
                  vertical: 5,
                ),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.8),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 16),
                    SizedBox(width: 5),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }

  Color _colorFor(String k) {
    switch (k) {
      case 'normal':
        return Colors.greenAccent.shade700;
      case 'crackle':
        return Colors.orangeAccent;
      case 'wheeze':
        return Colors.blueAccent;
      case 'both':
        return Colors.purpleAccent;
      default:
        return Colors.grey;
    }
  }
}


       --- File Content End ---


    üìÑ result_stethoscope.dart

       --- File Content Start ---

// lib/result_stethoscope.dart
import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'scale.dart';
import 'prediction_logs.dart';
import 'dart:math';

class ResultStethoscopePage extends StatefulWidget {
  final Map<String, double>
  percentages; // keys: 'normal','wheeze','crackle','both'
  final String mainLabel;
  final List<String>? logs;

  const ResultStethoscopePage({
    super.key,
    required this.percentages,
    required this.mainLabel,
    this.logs,
  });

  @override
  State<ResultStethoscopePage> createState() => _ResultStethoscopePageState();
}

class _ResultStethoscopePageState extends State<ResultStethoscopePage> {
  int _tapCount = 0;
  DateTime? _firstTapAt;

  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  @override
  void initState() {
    super.initState();
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Initialize TTS and speak results
  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak results
      await Future.delayed(const Duration(milliseconds: 500));
      await _speakResults();
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  // ‚úÖ ADD: Speak the stethoscope analysis results
  Future<void> _speakResults() async {
    final order = ['normal', 'crackle', 'wheeze', 'both'];
    final entries = order
        .map((k) => MapEntry(k, widget.percentages[k] ?? 0.0))
        .toList();

    // Build result announcement
    String announcement = "Lung sound analysis complete. ";
    announcement += "Main detection: ${widget.mainLabel}. ";

    // Add percentages
    announcement += "Confidence levels: ";
    for (var entry in entries) {
      final rounded = entry.value.round();
      announcement += "${entry.key}, $rounded percent. ";
    }

    // Add medical interpretation based on main label
    final mainLower = widget.mainLabel.toLowerCase();
    if (mainLower == 'normal') {
      announcement += "Lung sounds appear normal. No abnormalities detected.";
    } else if (mainLower == 'crackle') {
      final crackleVal = widget.percentages['crackle'] ?? 0.0;
      if (crackleVal >= 70) {
        announcement +=
            "Significant crackles detected. These may indicate fluid in the lungs. Medical consultation recommended.";
      } else {
        announcement +=
            "Crackles detected. Consider medical evaluation for proper diagnosis.";
      }
    } else if (mainLower == 'wheeze') {
      final wheezeVal = widget.percentages['wheeze'] ?? 0.0;
      if (wheezeVal >= 70) {
        announcement +=
            "Significant wheezing detected. This may indicate airway obstruction. Medical consultation recommended.";
      } else {
        announcement +=
            "Wheezing detected. Consider medical evaluation for proper diagnosis.";
      }
    } else if (mainLower == 'both') {
      announcement +=
          "Both crackles and wheezes detected. This indicates possible respiratory complications. Medical consultation strongly recommended.";
    }

    await _speak(announcement);
  }

  @override
  void dispose() {
    _flutterTts.stop();
    super.dispose();
  }

  void _handleGlobalTap() {
    final now = DateTime.now();
    if (_firstTapAt == null || now.difference(_firstTapAt!).inSeconds > 5) {
      _firstTapAt = now;
      _tapCount = 0;
    }
    _tapCount += 1;
    if (_tapCount >= 15) {
      _tapCount = 0;
      _firstTapAt = null;

      // ‚úÖ Speak before navigating
      _speak("Opening prediction logs");

      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (_) =>
              PredictionLogsPage(logs: widget.logs ?? const <String>[]),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final bg = 'assets/background.png';
    final lungs = 'assets/lungs_ai.png';

    final order = ['normal', 'crackle', 'wheeze', 'both'];
    final entries = order
        .map((k) => MapEntry(k, widget.percentages[k] ?? 0.0))
        .toList();

    final maxVal = entries.map((e) => e.value).fold<double>(0.0, max);

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: GestureDetector(
        behavior: HitTestBehavior.opaque,
        onTap: _handleGlobalTap,
        child: Stack(
          children: [
            Positioned.fill(child: Image.asset(bg, fit: BoxFit.cover)),
            Positioned(
              left: 0,
              top: 0,
              width: S.w(context, 120),
              height: S.h(context, 160),
              child: Image.asset(lungs, fit: BoxFit.contain),
            ),
            Positioned.fill(
              child: SafeArea(
                child: Center(
                  child: Container(
                    width: min(
                      MediaQuery.of(context).size.width * 0.84,
                      S.w(context, 1200),
                    ),
                    padding: const EdgeInsets.all(22),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.86),
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.08),
                          blurRadius: 18,
                        ),
                      ],
                    ),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Text(
                          'Analysis Result',
                          style: TextStyle(
                            fontSize: S.fs(context, 28),
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 12),
                        Text(
                          'Detected: ${widget.mainLabel.toUpperCase()}',
                          style: TextStyle(
                            fontSize: S.fs(context, 20),
                            fontWeight: FontWeight.w700,
                            color: Colors.deepPurple,
                          ),
                        ),
                        const SizedBox(height: 20),

                        // Bars
                        Row(
                          crossAxisAlignment: CrossAxisAlignment.end,
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: entries.map((e) {
                            final label = e.key;
                            final val = e.value;
                            final barHeight =
                                (val / (maxVal == 0 ? 1 : maxVal)) * 220;
                            final color = _colorFor(label);
                            return Padding(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 18.0,
                              ),
                              child: Column(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Text(
                                    '${val.toStringAsFixed(1)}%',
                                    style: TextStyle(
                                      fontSize: S.fs(context, 14),
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                  const SizedBox(height: 8),
                                  Container(
                                    width: 60,
                                    height: 220,
                                    alignment: Alignment.bottomCenter,
                                    decoration: BoxDecoration(
                                      color: Colors.grey.shade200,
                                      borderRadius: BorderRadius.circular(10),
                                    ),
                                    child: AnimatedContainer(
                                      duration: const Duration(
                                        milliseconds: 600,
                                      ),
                                      width: 60,
                                      height: barHeight,
                                      decoration: BoxDecoration(
                                        color: color,
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                    ),
                                  ),
                                  const SizedBox(height: 8),
                                  Text(
                                    label.toUpperCase(),
                                    style: TextStyle(
                                      fontSize: S.fs(context, 14),
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                ],
                              ),
                            );
                          }).toList(),
                        ),

                        const SizedBox(height: 22),

                        Container(
                          padding: const EdgeInsets.all(14),
                          decoration: BoxDecoration(
                            color: Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: Column(
                            children: [
                              Text(
                                'Confidence breakdown',
                                style: TextStyle(
                                  fontSize: S.fs(context, 16),
                                  fontWeight: FontWeight.w700,
                                ),
                              ),
                              const SizedBox(height: 8),
                              Wrap(
                                spacing: 12,
                                runSpacing: 8,
                                children: entries.map((e) {
                                  return Chip(
                                    backgroundColor: _colorFor(
                                      e.key,
                                    ).withOpacity(0.14),
                                    label: Text(
                                      '${e.key}: ${e.value.toStringAsFixed(1)}%',
                                    ),
                                  );
                                }).toList(),
                              ),
                            ],
                          ),
                        ),

                        const SizedBox(height: 16),
                        ElevatedButton(
                          onPressed: () {
                            // ‚úÖ Speak before navigating back
                            _speak("Returning to home screen");
                            Navigator.of(
                              context,
                            ).popUntil((route) => route.isFirst);
                          },
                          child: const Text('Done'),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),

            // ‚úÖ ADD: Speaking indicator
            if (_isSpeaking)
              Positioned(
                top: 20,
                right: 20,
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 5,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.blue.shade400.withOpacity(0.8),
                    borderRadius: BorderRadius.circular(15),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: const [
                      Icon(Icons.volume_up, color: Colors.white, size: 16),
                      SizedBox(width: 5),
                      Text(
                        'Speaking',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }

  Color _colorFor(String k) {
    switch (k) {
      case 'normal':
        return Colors.greenAccent.shade700;
      case 'crackle':
        return Colors.orangeAccent;
      case 'wheeze':
        return Colors.blueAccent;
      case 'both':
        return Colors.purpleAccent;
      default:
        return Colors.grey;
    }
  }
}


       --- File Content End ---


    üìÑ result_xray.dart

       --- File Content Start ---

import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart';
import 'scale.dart';
import 'prediction_logs.dart';
import 'dart:math';

class ResultXRayPage extends StatefulWidget {
  final Map<String, double> percentages;
  final String mainLabel;
  final List<String>? logs;

  const ResultXRayPage({
    super.key,
    required this.percentages,
    required this.mainLabel,
    this.logs,
  });

  @override
  State<ResultXRayPage> createState() => _ResultXRayPageState();
}

class _ResultXRayPageState extends State<ResultXRayPage> {
  int _tapCount = 0;
  DateTime? _firstTapAt;

  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  // ‚úÖ ADD: Modified percentages and label
  late Map<String, double> _displayPercentages;
  late String _displayLabel;

  @override
  void initState() {
    super.initState();
    _processResults(); // ‚úÖ Process results based on your logic
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Process results with your custom logic
  void _processResults() {
    // Get the original pneumonia percentage
    final pneumoniaKey = widget.percentages.containsKey('Pneumonia')
        ? 'Pneumonia'
        : 'pneumonia';
    final healthyKey = widget.percentages.containsKey('Healthy')
        ? 'Healthy'
        : 'normal';

    final originalPneumonia = widget.percentages[pneumoniaKey] ?? 0.0;

    if (originalPneumonia >= 97.0) {
      // If pneumonia >= 97%, keep original values and label as pneumonia
      _displayPercentages = Map.from(widget.percentages);
      _displayLabel = 'Pneumonia';
    } else {
      // Otherwise, classify as healthy with random percentages
      final random = Random();

      // Generate pneumonia percentage between 5-25%
      final newPneumonia = 5.0 + random.nextDouble() * 20.0;

      // Generate healthy percentage approximately 3x higher
      // Range: 2.5x to 3.5x of pneumonia percentage, but not exceeding 100%
      final multiplier = 2.5 + random.nextDouble();
      double newHealthy = newPneumonia * multiplier;

      // Ensure healthy percentage is between 60-95%
      newHealthy = newHealthy.clamp(60.0, 95.0);

      // Ensure pneumonia + healthy doesn't exceed 100%
      if (newPneumonia + newHealthy > 100.0) {
        newHealthy = 100.0 - newPneumonia;
      }

      _displayPercentages = {
        healthyKey: newHealthy,
        pneumoniaKey: newPneumonia,
      };
      _displayLabel = 'Healthy';

      // Debug print
      debugPrint(
        "üîÑ Modified results - Original Pneumonia: ${originalPneumonia.toStringAsFixed(1)}%",
      );
      debugPrint(
        "üîÑ New: Healthy=${newHealthy.toStringAsFixed(1)}%, Pneumonia=${newPneumonia.toStringAsFixed(1)}%",
      );
    }
  }

  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      await Future.delayed(const Duration(milliseconds: 500));
      await _speakResults();
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  Future<void> _speakResults() async {
    // Use display percentages instead of original
    final healthyKey = _displayPercentages.containsKey('Healthy')
        ? 'Healthy'
        : 'normal';
    final pneumoniaKey = _displayPercentages.containsKey('Pneumonia')
        ? 'Pneumonia'
        : 'pneumonia';

    final healthyVal = _displayPercentages[healthyKey] ?? 0.0;
    final pneumoniaVal = _displayPercentages[pneumoniaKey] ?? 0.0;

    String announcement = "X-ray analysis complete. ";
    announcement += "Main detection: $_displayLabel. ";

    announcement += "Confidence levels: ";
    announcement += "Healthy, ${healthyVal.round()} percent. ";
    announcement += "Pneumonia, ${pneumoniaVal.round()} percent. ";

    if (_displayLabel.toLowerCase() == 'healthy' ||
        _displayLabel.toLowerCase() == 'normal') {
      announcement +=
          "Chest X-ray appears normal. No signs of pneumonia detected.";
    } else if (_displayLabel.toLowerCase() == 'pneumonia') {
      if (pneumoniaVal >= 97) {
        announcement +=
            "Very high confidence pneumonia detection. Immediate medical consultation strongly recommended.";
      } else if (pneumoniaVal >= 80) {
        announcement +=
            "High confidence pneumonia detection. Medical consultation recommended.";
      } else if (pneumoniaVal >= 60) {
        announcement +=
            "Moderate confidence pneumonia detection. Consider medical consultation.";
      } else {
        announcement +=
            "Possible pneumonia indicators detected. Consider medical consultation for confirmation.";
      }
    }

    await _speak(announcement);
  }

  @override
  void dispose() {
    _flutterTts.stop();
    super.dispose();
  }

  void _handleGlobalTap() {
    final now = DateTime.now();
    if (_firstTapAt == null || now.difference(_firstTapAt!).inSeconds > 5) {
      _firstTapAt = now;
      _tapCount = 0;
    }
    _tapCount += 1;
    if (_tapCount >= 15) {
      _tapCount = 0;
      _firstTapAt = null;

      _speak("Opening prediction logs");

      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (_) =>
              PredictionLogsPage(logs: widget.logs ?? const <String>[]),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    const bg = 'assets/background.png';
    const lungs = 'assets/lungs_ai.png';

    // Use display percentages instead of original
    final healthyKey = _displayPercentages.containsKey('Healthy')
        ? 'Healthy'
        : 'normal';
    final pneumoniaKey = _displayPercentages.containsKey('Pneumonia')
        ? 'Pneumonia'
        : 'pneumonia';

    final healthyVal = _displayPercentages[healthyKey] ?? 0.0;
    final pneumoniaVal = _displayPercentages[pneumoniaKey] ?? 0.0;

    final entries = [
      MapEntry('Healthy', healthyVal),
      MapEntry('Pneumonia', pneumoniaVal),
    ];

    final maxVal = entries.map((e) => e.value).fold<double>(0.0, max);

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: GestureDetector(
        behavior: HitTestBehavior.opaque,
        onTap: _handleGlobalTap,
        child: Stack(
          children: [
            Positioned.fill(child: Image.asset(bg, fit: BoxFit.cover)),
            Positioned(
              left: 0,
              top: 0,
              width: S.w(context, 120),
              height: S.h(context, 160),
              child: Image.asset(lungs, fit: BoxFit.contain),
            ),

            Positioned.fill(
              child: SafeArea(
                child: Center(
                  child: Container(
                    width: min(
                      MediaQuery.of(context).size.width * 0.84,
                      S.w(context, 1200),
                    ),
                    padding: const EdgeInsets.all(22),
                    decoration: BoxDecoration(
                      color: Colors.white.withOpacity(0.86),
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withOpacity(0.08),
                          blurRadius: 18,
                        ),
                      ],
                    ),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Text(
                          "X-Ray Analysis Result",
                          style: TextStyle(
                            fontSize: S.fs(context, 28),
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        const SizedBox(height: 12),
                        Text(
                          "Detected: ${_displayLabel.toUpperCase()}", // ‚úÖ Use display label
                          style: TextStyle(
                            fontSize: S.fs(context, 20),
                            fontWeight: FontWeight.w700,
                            color:
                                _displayLabel.toLowerCase() == 'healthy' ||
                                    _displayLabel.toLowerCase() == 'normal'
                                ? Colors.green.shade700
                                : Colors.deepPurple,
                          ),
                        ),
                        const SizedBox(height: 20),

                        // Bars
                        Row(
                          crossAxisAlignment: CrossAxisAlignment.end,
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: entries.map((e) {
                            final label = e.key;
                            final val = e.value;
                            final barHeight =
                                (val / (maxVal == 0 ? 1 : maxVal)) * 220;
                            final color = _colorFor(label);
                            return Padding(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 28.0,
                              ),
                              child: Column(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Text(
                                    "${val.toStringAsFixed(1)}%",
                                    style: TextStyle(
                                      fontSize: S.fs(context, 14),
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                  const SizedBox(height: 8),
                                  Container(
                                    width: 70,
                                    height: 220,
                                    alignment: Alignment.bottomCenter,
                                    decoration: BoxDecoration(
                                      color: Colors.grey.shade200,
                                      borderRadius: BorderRadius.circular(10),
                                    ),
                                    child: AnimatedContainer(
                                      duration: const Duration(
                                        milliseconds: 600,
                                      ),
                                      width: 70,
                                      height: barHeight,
                                      decoration: BoxDecoration(
                                        color: color,
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                    ),
                                  ),
                                  const SizedBox(height: 8),
                                  Text(
                                    label.toUpperCase(),
                                    style: TextStyle(
                                      fontSize: S.fs(context, 16),
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                ],
                              ),
                            );
                          }).toList(),
                        ),

                        const SizedBox(height: 22),

                        // Confidence breakdown
                        Container(
                          padding: const EdgeInsets.all(14),
                          decoration: BoxDecoration(
                            color: Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: Column(
                            children: [
                              Text(
                                "Confidence breakdown",
                                style: TextStyle(
                                  fontSize: S.fs(context, 16),
                                  fontWeight: FontWeight.w700,
                                ),
                              ),
                              const SizedBox(height: 8),
                              Wrap(
                                spacing: 12,
                                runSpacing: 8,
                                children: entries.map((e) {
                                  return Chip(
                                    backgroundColor: _colorFor(
                                      e.key,
                                    ).withOpacity(0.14),
                                    label: Text(
                                      "${e.key}: ${e.value.toStringAsFixed(1)}%",
                                      style: TextStyle(
                                        fontWeight: FontWeight.w600,
                                      ),
                                    ),
                                  );
                                }).toList(),
                              ),
                            ],
                          ),
                        ),

                        const SizedBox(height: 16),
                        ElevatedButton(
                          onPressed: () {
                            _speak("Returning to home screen");
                            Navigator.of(context).popUntil((r) => r.isFirst);
                          },
                          child: const Text("Done"),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),

            if (_isSpeaking)
              Positioned(
                top: 20,
                right: 20,
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 5,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.blue.shade400.withOpacity(0.8),
                    borderRadius: BorderRadius.circular(15),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: const [
                      Icon(Icons.volume_up, color: Colors.white, size: 16),
                      SizedBox(width: 5),
                      Text(
                        'Speaking',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }

  Color _colorFor(String k) {
    switch (k.toLowerCase()) {
      case 'healthy':
      case 'normal':
        return Colors.greenAccent.shade700;
      case 'pneumonia':
        return Colors.redAccent.shade400;
      default:
        return Colors.grey;
    }
  }
}


       --- File Content End ---


    üìÑ scale.dart

       --- File Content Start ---

import 'package:flutter/material.dart';

class S extends ChangeNotifier {
  static bool enabled = false;
  static const double designWidth = 2000.0;
  static const double designHeight = 1200.0;

  // Expose a singleton notifier so widgets like MaterialApp can listen
  static final S notifier = S._();

  S._();
  S();

  static void toggle() {
    enabled = !enabled;
    notifier.notifyListeners();
  }

  static void setEnabled(bool value) {
    if (enabled == value) return;
    enabled = value;
    notifier.notifyListeners();
  }

  static double w(BuildContext context, double x) {
    if (!enabled) return x;
    final size = MediaQuery.of(context).size;
    return (size.width / designWidth) * x;
  }

  static double h(BuildContext context, double y) {
    if (!enabled) return y;
    final size = MediaQuery.of(context).size;
    return (size.height / designHeight) * y;
  }

  static double fs(BuildContext context, double s) {
    if (!enabled) return s;
    final size = MediaQuery.of(context).size;
    final scale = (size.width / designWidth + size.height / designHeight) / 2.0;
    return s * scale;
  }

  // Padding helpers to scale spacing when enabled
  static EdgeInsets pAll(BuildContext context, double value) {
    final v = enabled ? w(context, value) : value;
    return EdgeInsets.all(v);
  }

  static EdgeInsets pSymmetric(
    BuildContext context, {
    double horizontal = 0,
    double vertical = 0,
  }) {
    final horizontalScaled = enabled ? w(context, horizontal) : horizontal;
    final verticalScaled = enabled ? S.h(context, vertical) : vertical;
    return EdgeInsets.symmetric(
      horizontal: horizontalScaled,
      vertical: verticalScaled,
    );
  }

  static EdgeInsets pLTRB(
    BuildContext context,
    double left,
    double top,
    double right,
    double bottom,
  ) {
    final l = enabled ? w(context, left) : left;
    final t = enabled ? h(context, top) : top;
    final r = enabled ? w(context, right) : right;
    final b = enabled ? h(context, bottom) : bottom;
    return EdgeInsets.fromLTRB(l, t, r, b);
  }

  // Corner radius helper
  static BorderRadius brAll(BuildContext context, double radius) {
    final r = enabled ? w(context, radius) : radius;
    return BorderRadius.circular(r);
  }
}


       --- File Content End ---


    üìÑ splash_screen.dart

       --- File Content Start ---

// lib/splash_screen.dart
import 'dart:async';
import 'dart:math';
import 'dart:ui' show lerpDouble;
import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart';
import 'next_screen.dart';

class SplashScreen extends StatefulWidget {
  const SplashScreen({super.key});

  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen>
    with TickerProviderStateMixin {
  // Controllers
  late final AnimationController _rocketController;
  late final AnimationController _shakeController;
  late final AnimationController _waveController;
  late final AnimationController _logoDropController;
  late final AnimationController _finalParticlesController;
  late final AnimationController _checkScaleController;

  // ‚úÖ TTS Engine
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  final Random _random = Random();

  // Stage state
  int _stage = 0;
  bool _engineInitializedTextShown = false;

  // Rockets and particles
  final List<_Rocket> _rockets = [];
  final int _numRockets = 9;
  final List<_Particle> _particles = [];

  @override
  void initState() {
    super.initState();

    // Initialize TTS
    _initTts();

    // Rockets
    _rocketController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 900),
    );

    for (int i = 0; i < _numRockets; i++) {
      _rockets.add(_Rocket(_random));
    }

    // Shake/vibration
    _shakeController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 140),
    );

    // Waveform
    _waveController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    )..repeat();

    // Logo drop
    _logoDropController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1200),
    );

    // Final particles
    _finalParticlesController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1800),
    );

    // Check scale
    _checkScaleController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 600),
    );

    _finalParticlesController.addListener(() {
      if (mounted) setState(() {});
    });

    // Start sequence
    _startSequence();
  }

  // ‚úÖ Initialize and configure TTS
  Future<void> _initTts() async {
    _flutterTts = FlutterTts();

    try {
      // Configure TTS settings for best quality
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5); // Slower = clearer (0.0 to 1.0)
      await _flutterTts.setVolume(1.0); // Max volume
      await _flutterTts.setPitch(1.0); // Normal pitch

      // Try to set a better voice
      if (Theme.of(context).platform == TargetPlatform.android) {
        // Google's neural voice (high quality)
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      // Set completion handlers
      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      debugPrint("‚úÖ TTS initialized successfully");
    } catch (e) {
      debugPrint("‚ùå TTS initialization error: $e");
    }
  }

  // ‚úÖ Speak text with TTS
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  Future<void> _startSequence() async {
    if (!mounted) return;

    // ‚úÖ Stage 0: Activation (10s)
    setState(() {
      _stage = 0;
      _engineInitializedTextShown = false;
    });

    // ‚úÖ Speak: "Activating AI Engine"
    await _speak("Activating AI Engine");
    await Future.delayed(const Duration(milliseconds: 500));

    _shakeController.repeat(reverse: true);
    await Future.delayed(const Duration(seconds: 10));
    if (!mounted) return;

    // Show AI initialized text
    setState(() {
      _engineInitializedTextShown = true;
    });
    _shakeController.stop(canceled: false);

    // ‚úÖ Speak: "AI Engine Initialized Successfully"
    await _speak("AI Engine Initialized Successfully");

    await Future.delayed(const Duration(seconds: 3));
    if (!mounted) return;

    // ‚úÖ Stage 1: Comparing audio samples (10s)
    setState(() {
      _stage = 1;
      _engineInitializedTextShown = false;
    });

    // ‚úÖ Speak: "Comparing Audio Samples"
    await _speak("Comparing Audio Samples");
    await Future.delayed(const Duration(milliseconds: 800));

    // ‚úÖ Speak analysis phrases during stage 1
    _speakAnalysisPhrases();

    await Future.delayed(const Duration(seconds: 10));
    if (!mounted) return;

    // ‚úÖ Stage 2: Final PneumoAI initialized
    setState(() {
      _stage = 2;
    });

    _createParticles();
    _logoDropController.forward(from: 0.0);
    _finalParticlesController.repeat();
    _checkScaleController.forward(from: 0.0);

    // ‚úÖ Speak: "PneumoAI Initialized Successfully"
    await Future.delayed(const Duration(milliseconds: 600));
    await _speak(
      "PneumoAI Initialized Successfully. Systems nominal. Ready to analyze.",
    );

    await Future.delayed(const Duration(seconds: 10));
    if (!mounted) return;

    // Stop animations
    _finalParticlesController.stop(canceled: false);
    _logoDropController.reset();
    _checkScaleController.reset();
    _particles.clear();

    // Stop any ongoing speech
    await _flutterTts.stop();

    // Navigate
    if (!mounted) return;
    Navigator.pushReplacement(
      context,
      MaterialPageRoute(builder: (_) => NextPage()),
    );
  }

  // ‚úÖ Speak analysis phrases during stage 1
  Future<void> _speakAnalysisPhrases() async {
    final phrases = [
      "Detecting crackles and wheezes",
      "Filtering background noise",
      "Analyzing spectral fingerprints",
    ];

    for (int i = 0; i < phrases.length && _stage == 1; i++) {
      await Future.delayed(const Duration(milliseconds: 2500));
      if (_stage == 1 && mounted) {
        await _speak(phrases[i]);
      }
    }
  }

  @override
  void dispose() {
    _rocketController.dispose();
    _shakeController.dispose();
    _waveController.dispose();
    _logoDropController.dispose();
    _finalParticlesController.dispose();
    _checkScaleController.dispose();

    // ‚úÖ Clean up TTS
    _flutterTts.stop();

    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final botSize = min(size.width, size.height) * 0.34;
    final logoSize = min(size.width, size.height) * 0.24;
    final titleFont = (min(size.width, size.height) * 0.045).clamp(20.0, 40.0);
    final subtitleFont = (min(size.width, size.height) * 0.032).clamp(
      16.0,
      30.0,
    );

    return Scaffold(
      body: Stack(
        children: [
          // Background
          Positioned.fill(
            child: Image.asset('assets/background.png', fit: BoxFit.cover),
          ),

          // ‚úÖ Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 50,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 6,
                ),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.9),
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 18),
                    SizedBox(width: 6),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 14,
                      ),
                    ),
                  ],
                ),
              ),
            ),

          // Foreground animations
          AnimatedBuilder(
            animation: _shakeController,
            builder: (context, child) {
              double vibrate = 0.0;
              if (_stage == 0 && !_engineInitializedTextShown) {
                vibrate = 6.0 * sin(_shakeController.value * pi * 2);
              }
              return Transform.translate(
                offset: Offset(vibrate, 0),
                child: child,
              );
            },
            child: Stack(
              children: [
                Center(
                  child: SizedBox(
                    width: size.width,
                    height: size.height,
                    child: _buildStageContent(
                      size,
                      botSize,
                      logoSize,
                      titleFont,
                      subtitleFont,
                    ),
                  ),
                ),
                if (_stage == 2 && _particles.isNotEmpty)
                  Positioned.fill(
                    child: IgnorePointer(
                      child: CustomPaint(
                        painter: _ParticlePainter(
                          _particles,
                          _finalParticlesController.value,
                        ),
                      ),
                    ),
                  ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStageContent(
    Size size,
    double botSize,
    double logoSize,
    double titleFont,
    double subtitleFont,
  ) {
    switch (_stage) {
      case 0:
        return Center(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              SizedBox(
                width: botSize,
                height: botSize,
                child: Image.asset('assets/ai_bot.png', fit: BoxFit.contain),
              ),
              const SizedBox(height: 28),
              Text(
                !_engineInitializedTextShown
                    ? "Activating AI Engine..."
                    : "AI Engine Initialized Successfully",
                textAlign: TextAlign.center,
                style: TextStyle(
                  color: Colors.black87,
                  fontSize: titleFont,
                  fontWeight: FontWeight.w800,
                  shadows: !_engineInitializedTextShown
                      ? [
                          Shadow(
                            color: Colors.blue.withOpacity(0.12),
                            blurRadius: 12,
                          ),
                        ]
                      : [
                          Shadow(
                            color: Colors.green.withOpacity(0.15),
                            blurRadius: 18,
                          ),
                        ],
                ),
              ),
              const SizedBox(height: 16),
              Opacity(
                opacity: _engineInitializedTextShown ? 0.0 : 1.0,
                child: Text(
                  "Booting neural modules ¬∑ calibrating sensors",
                  style: TextStyle(
                    fontSize: subtitleFont * 0.8,
                    color: Colors.grey[700],
                  ),
                ),
              ),
            ],
          ),
        );

      case 1:
        final List<String> phrases = [
          "Detecting crackles and wheezes....",
          "Filtering background noise...",
          "Detecting wheezes and crackles...",
          "Analyzing spectral fingerprints...",
        ];
        return StatefulBuilder(
          builder: (context, setState) {
            int currentPhrase = 0;
            Timer.periodic(const Duration(milliseconds: 2500), (timer) {
              if (!mounted || _stage != 1) {
                timer.cancel();
                return;
              }
              setState(() {
                currentPhrase = (currentPhrase + 1) % phrases.length;
              });
            });

            return Center(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Text(
                    "Comparing Audio Samples...",
                    style: TextStyle(
                      color: Colors.blueAccent.shade700,
                      fontSize: titleFont,
                      fontWeight: FontWeight.w800,
                    ),
                  ),
                  const SizedBox(height: 18),
                  SizedBox(
                    width: size.width * 0.78,
                    height: size.height * 0.26,
                    child: Stack(
                      alignment: Alignment.center,
                      children: [
                        AnimatedBuilder(
                          animation: _waveController,
                          builder: (context, child) {
                            return Transform.rotate(
                              angle: _waveController.value * pi * 2,
                              child: Container(
                                width: size.width * 0.48,
                                height: size.width * 0.48,
                                decoration: BoxDecoration(
                                  shape: BoxShape.circle,
                                  border: Border.all(
                                    color: Colors.blueAccent.withOpacity(0.12),
                                    width: 8,
                                  ),
                                ),
                              ),
                            );
                          },
                        ),
                        Positioned(
                          left: 0,
                          right: 0,
                          top: 8,
                          bottom: 8,
                          child: Center(
                            child: SizedBox(
                              height: size.height * 0.12,
                              child: WaveformAnimation(
                                controller: _waveController,
                              ),
                            ),
                          ),
                        ),
                        Positioned(
                          bottom: 6,
                          left: 12,
                          right: 12,
                          child: SizedBox(
                            height: size.height * 0.10,
                            child: SpectrumBars(controller: _waveController),
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    phrases[currentPhrase],
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      fontSize: subtitleFont * 0.95,
                      color: Colors.grey[800],
                    ),
                  ),
                ],
              ),
            );
          },
        );

      case 2:
        return Stack(
          children: [
            AnimatedBuilder(
              animation: _logoDropController,
              builder: (context, child) {
                final t = Curves.easeOutBack.transform(
                  _logoDropController.value,
                );
                final top = lerpDouble(-logoSize, size.height * 0.18, t)!;
                return Positioned(
                  top: top,
                  left: (size.width - logoSize) / 2,
                  child: SizedBox(
                    width: logoSize,
                    height: logoSize,
                    child: Container(
                      decoration: BoxDecoration(
                        boxShadow: [
                          BoxShadow(
                            color: Colors.blueAccent.withOpacity(
                              0.28 * t + 0.1,
                            ),
                            blurRadius: 30 * t + 8,
                            spreadRadius: 8 * t,
                          ),
                        ],
                      ),
                      child: Image.asset('assets/logo.png'),
                    ),
                  ),
                );
              },
            ),
            Align(
              alignment: Alignment.center,
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  ScaleTransition(
                    scale: Tween<double>(begin: 0.6, end: 1.0).animate(
                      CurvedAnimation(
                        parent: _checkScaleController,
                        curve: Curves.elasticOut,
                      ),
                    ),
                    child: Container(
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        color: Colors.greenAccent.shade400.withOpacity(0.95),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.greenAccent.shade200.withOpacity(0.6),
                            blurRadius: 18,
                            spreadRadius: 6,
                          ),
                        ],
                      ),
                      padding: const EdgeInsets.all(18),
                      child: const Icon(
                        Icons.check_rounded,
                        size: 48,
                        color: Colors.white,
                      ),
                    ),
                  ),
                  const SizedBox(height: 18),
                  Text(
                    "PneumoAI Initialized Successfully",
                    textAlign: TextAlign.center,
                    style: TextStyle(
                      color: Colors.green.shade700,
                      fontWeight: FontWeight.w900,
                      fontSize: titleFont * 0.95,
                      shadows: [
                        Shadow(
                          color: Colors.green.withOpacity(0.12),
                          blurRadius: 22,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    "Systems nominal ¬∑ Ready to analyze",
                    style: TextStyle(
                      fontSize: subtitleFont * 0.9,
                      color: Colors.grey[800],
                    ),
                  ),
                ],
              ),
            ),
          ],
        );

      default:
        return const SizedBox.shrink();
    }
  }

  void _createParticles() {
    _particles.clear();
    final w = MediaQuery.of(context).size.width;
    final h = MediaQuery.of(context).size.height;
    for (int i = 0; i < 26; i++) {
      final angle = _random.nextDouble() * pi * 2;
      final speed = 120.0 + _random.nextDouble() * 200.0;
      final radius = 4.0 + _random.nextDouble() * 6.0;
      final color = _colors[_random.nextInt(_colors.length)];
      _particles.add(
        _Particle(
          origin: Offset(w / 2, h * 0.25),
          vx: cos(angle) * speed,
          vy: sin(angle) * speed - 60,
          radius: radius,
          color: color,
          life: 1.6 + _random.nextDouble() * 1.0,
        ),
      );
    }
  }

  static const List<Color> _colors = [
    Colors.redAccent,
    Colors.orangeAccent,
    Colors.blueAccent,
    Colors.greenAccent,
    Colors.purpleAccent,
    Colors.yellowAccent,
  ];
}

// ==================== Helper Classes ====================

class WaveformAnimation extends StatelessWidget {
  final AnimationController controller;
  const WaveformAnimation({super.key, required this.controller});

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: controller,
      builder: (context, child) {
        return CustomPaint(painter: WaveformPainter(controller.value));
      },
    );
  }
}

class WaveformPainter extends CustomPainter {
  final double progress;
  WaveformPainter(this.progress);

  @override
  void paint(Canvas canvas, Size size) {
    final Paint paint = Paint()
      ..strokeWidth = 3
      ..style = PaintingStyle.stroke
      ..shader = LinearGradient(
        colors: [Colors.blueAccent, Colors.lightBlueAccent],
      ).createShader(Rect.fromLTWH(0, 0, size.width, size.height));
    final Path path = Path();
    for (double x = 0; x <= size.width; x++) {
      final t = (x / size.width) * 4 * pi;
      final y =
          size.height / 2 + (size.height / 2.5) * sin(t + progress * 6.28);
      if (x == 0) {
        path.moveTo(x, y);
      } else {
        path.lineTo(x, y);
      }
    }
    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant WaveformPainter oldDelegate) => true;
}

class SpectrumBars extends StatelessWidget {
  final AnimationController controller;
  const SpectrumBars({super.key, required this.controller});

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: controller,
      builder: (context, child) {
        return CustomPaint(painter: SpectrumPainter(controller.value));
      },
    );
  }
}

class SpectrumPainter extends CustomPainter {
  final double progress;
  SpectrumPainter(this.progress);

  @override
  void paint(Canvas canvas, Size size) {
    final Paint paint = Paint()..style = PaintingStyle.fill;
    final int bars = 20;
    final double gap = 6.0;
    final double barW = (size.width - (bars - 1) * gap) / bars;
    final centerY = size.height / 2;

    for (int i = 0; i < bars; i++) {
      final double phase = (i / bars) * pi * 2;
      final double h =
          (size.height * 0.9) *
          (0.2 + 0.8 * (0.5 + 0.5 * sin(progress * 2 * pi + phase * 1.3)));
      final rect = Rect.fromLTWH(i * (barW + gap), centerY - h / 2, barW, h);

      paint.shader = LinearGradient(
        colors: [
          Colors.blueAccent.withOpacity(0.95 - i * 0.02),
          Colors.lightBlueAccent.withOpacity(0.6),
        ],
        begin: Alignment.topCenter,
        end: Alignment.bottomCenter,
      ).createShader(rect);

      canvas.drawRRect(
        RRect.fromRectAndRadius(rect, const Radius.circular(6)),
        paint,
      );
    }
  }

  @override
  bool shouldRepaint(covariant SpectrumPainter oldDelegate) => true;
}

class _Rocket {
  double x;
  double y;
  double vx;
  double vy;
  double angle;
  double size;
  final Random random;

  _Rocket(this.random)
    : x = random.nextDouble() * 900,
      y = -20.0 - random.nextDouble() * 600.0,
      vx = -10 + random.nextDouble() * 20,
      vy = 60 + random.nextDouble() * 180,
      angle = random.nextDouble() * pi * 2,
      size = 28 + random.nextDouble() * 40;

  void update(Size screen, {bool falling = false}) {
    if (falling) {
      vy += 4 * (0.7 + random.nextDouble() * 0.6);
      y += vy * 0.016;
      x += vx * 0.016;
      angle += 0.04;
    } else {
      x += (vx * 0.004);
      y += (vy * 0.004);
      angle += 0.01;
    }

    if (y > screen.height + 100 || x < -120 || x > screen.width + 120) {
      x = random.nextDouble() * screen.width;
      y = -40 - random.nextDouble() * 200;
      vx = -30 + random.nextDouble() * 60;
      vy = 80 + random.nextDouble() * 160;
      size = 24 + random.nextDouble() * 46;
      angle = random.nextDouble() * pi * 2;
    }
  }

  void reset(Random r) {
    x = r.nextDouble() * 900;
    y = -20.0 - r.nextDouble() * 600.0;
    vx = -10 + r.nextDouble() * 20;
    vy = 60 + r.nextDouble() * 180;
    angle = r.nextDouble() * pi * 2;
    size = 24 + r.nextDouble() * 46;
  }
}

class _Particle {
  final Offset origin;
  final double vx;
  final double vy;
  final double radius;
  final Color color;
  final double life;

  _Particle({
    required this.origin,
    required this.vx,
    required this.vy,
    required this.radius,
    required this.color,
    required this.life,
  });
}

class _ParticlePainter extends CustomPainter {
  final List<_Particle> particles;
  final double t;

  _ParticlePainter(this.particles, this.t);

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()..style = PaintingStyle.fill;
    for (var p in particles) {
      final life = p.life;
      final f = Curves.easeOut.transform(
        min(1.0, t * (1.0 + 0.6 * (1.0 / life))),
      );
      final dx = p.vx * f;
      final dy = p.vy * f + (50.0 * f * f);
      final pos = Offset(p.origin.dx + dx, p.origin.dy + dy);
      paint.color = p.color.withOpacity((1.0 - f).clamp(0.0, 1.0));
      canvas.drawCircle(pos, p.radius * (1.0 - 0.2 * f), paint);
    }
  }

  @override
  bool shouldRepaint(covariant _ParticlePainter oldDelegate) => true;
}


       --- File Content End ---


    üìÑ stethoscope_main.dart

       --- File Content Start ---

import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'live_recording.dart';
import 'stethoscope_upload.dart';

class StethoscopeMainPage extends StatefulWidget {
  // ‚úÖ Changed to StatefulWidget
  const StethoscopeMainPage({super.key});

  @override
  _StethoscopeMainPageState createState() => _StethoscopeMainPageState();
}

class _StethoscopeMainPageState extends State<StethoscopeMainPage> {
  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  // ‚úÖ ADD: Initialize TTS
  @override
  void initState() {
    super.initState();
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Initialize TTS and speak welcome message
  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak welcome message
      await Future.delayed(const Duration(milliseconds: 300));
      await _speak(
        "Choose how to analyze your lung sounds. You can upload an audio file or record live",
      );
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  // ‚úÖ ADD: Dispose TTS
  @override
  void dispose() {
    _flutterTts.stop();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // üé® Color options
    const mainTextColor = Color(0xFF0d3b66);
    const buttonColor = Color(0xFF4B0082); // dark purple
    const buttonTextColor = Colors.white;

    // üñº Image sizes & positions
    const lungsWidth = 120.0;
    const lungsHeight = 160.0;
    const lungsLeft = 0.0;
    const lungsTop = 0.0;

    const titleFontSize = 60.0;
    const titleLeft = 180.0;
    const titleTop = 30.0;

    const stethoscopeWidth = 430.0;
    const stethoscopeHeight = 600.0;
    const stethoscopeLeft = 50.0;
    const stethoscopeTop = 170.0;

    // üîß Buttons
    const buttonWidth = 600.0;
    const buttonHeight = 180.0;
    const buttonBorderRadius = 90.0;
    const iconSize = 130.0;
    const iconTextSpacing = 20.0;

    const btn1Left = 650.0;
    const btn1Top = 220.0;

    const btn2Left = 650.0;
    const btn2Top = 500.0;

    return Scaffold(
      body: Stack(
        children: [
          // üåÑ Full background image
          Positioned.fill(
            child: Image.asset('assets/background.png', fit: BoxFit.cover),
          ),

          // Top-left lungs_ai.png image
          Positioned(
            left: lungsLeft,
            top: lungsTop,
            width: lungsWidth,
            height: lungsHeight,
            child: Image.asset('assets/lungs_ai.png', fit: BoxFit.contain),
          ),

          // Title text
          Positioned(
            left: titleLeft,
            top: titleTop,
            child: Text(
              "Analyze Your Lung Sounds With AI",
              style: TextStyle(
                fontSize: titleFontSize,
                fontWeight: FontWeight.bold,
                color: mainTextColor,
              ),
            ),
          ),

          // Central stethoscope image
          Positioned(
            left: stethoscopeLeft,
            top: stethoscopeTop,
            width: stethoscopeWidth,
            height: stethoscopeHeight,
            child: ClipRRect(
              borderRadius: BorderRadius.circular(30),
              child: Image.asset(
                'assets/stethoscope_icon.png',
                fit: BoxFit.cover,
              ),
            ),
          ),

          // Button 1: Upload Your Lung Sounds
          Positioned(
            left: btn1Left,
            top: btn1Top,
            child: SizedBox(
              width: buttonWidth,
              height: buttonHeight,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: buttonColor,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(buttonBorderRadius),
                  ),
                  elevation: 6,
                ),
                onPressed: () {
                  // ‚úÖ Speak before navigating
                  _speak("Upload lung sounds");

                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) => const StethoscopeUploadPage(),
                    ),
                  );
                },
                child: Row(
                  children: [
                    SizedBox(width: 20),
                    SizedBox(
                      width: iconSize,
                      height: iconSize,
                      child: Image.asset('assets/upload_icon.png'),
                    ),
                    SizedBox(width: iconTextSpacing),
                    Expanded(
                      child: Text(
                        "Upload Your Lung Sounds for AI Analyzation",
                        style: TextStyle(
                          fontSize: 32,
                          color: buttonTextColor,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),

          // Button 2: Record Audio For Live AI Analyzation
          Positioned(
            left: btn2Left,
            top: btn2Top,
            child: SizedBox(
              width: buttonWidth,
              height: buttonHeight,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: buttonColor,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(buttonBorderRadius),
                  ),
                  elevation: 6,
                ),
                onPressed: () {
                  // ‚úÖ Speak before navigating
                  _speak("Record live audio");

                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) => const LiveRecordingPage(),
                    ),
                  );
                },
                child: Row(
                  children: [
                    SizedBox(width: 20),
                    SizedBox(
                      width: iconSize,
                      height: iconSize,
                      child: Image.asset('assets/record_icon.png'),
                    ),
                    SizedBox(width: iconTextSpacing),
                    Expanded(
                      child: Text(
                        "Record Audio For Live AI Analyzation",
                        style: TextStyle(
                          fontSize: 32,
                          color: buttonTextColor,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),

          // ‚úÖ ADD: Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 20,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 10,
                  vertical: 5,
                ),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.8),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 16),
                    SizedBox(width: 5),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }
}


       --- File Content End ---


    üìÑ stethoscope_upload.dart

       --- File Content Start ---

// lib/stethoscope_upload.dart
import 'package:flutter/material.dart';
import 'package:file_picker/file_picker.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'dart:async';
import 'dart:math';
import 'stethoscope_upload_loading.dart';

class StethoscopeUploadPage extends StatefulWidget {
  const StethoscopeUploadPage({super.key});

  @override
  _StethoscopeUploadPageState createState() => _StethoscopeUploadPageState();
}

class _StethoscopeUploadPageState extends State<StethoscopeUploadPage> {
  String? _uploadedFileName;
  String? _uploadedFilePath;
  bool _showError = false;
  final _random = Random();

  // ‚úÖ TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  // ‚úÖ Responsive mode tracking
  int _tapCount = 0;
  bool _responsiveMode = false;
  Timer? _tapResetTimer;

  // ‚úÖ Reference screen size (Lenovo Yoga Tab 11: 2000 x 1200)
  static const double _referenceWidth = 2000.0;
  static const double _referenceHeight = 1200.0;

  // ‚úÖ ADD: Initialize TTS
  @override
  void initState() {
    super.initState();
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Initialize TTS and speak welcome message
  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak welcome message
      await Future.delayed(const Duration(milliseconds: 300));
      await _speak("Upload your lung sounds for AI analysis");
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  Future<void> _uploadFile() async {
    try {
      FilePickerResult? result = await FilePicker.platform.pickFiles(
        type: FileType.audio,
      );

      if (result != null && result.files.isNotEmpty) {
        setState(() {
          _uploadedFileName = result.files.single.name;
          _uploadedFilePath = result.files.single.path;
        });

        debugPrint("Selected file: $_uploadedFileName");
        debugPrint("Full path: $_uploadedFilePath");

        // ‚úÖ Speak success message
        await _speak(
          "Audio file uploaded successfully. You can now proceed to AI analysis",
        );
      }
    } catch (e) {
      debugPrint("File picker error: $e");
    }
  }

  void _showTransientError() {
    setState(() => _showError = true);

    // ‚úÖ Speak error message
    _speak("Please upload a lung sound audio file first");

    Timer(const Duration(milliseconds: 900), () {
      if (mounted) setState(() => _showError = false);
    });
  }

  void _startAnalysisByHalfTap(bool leftHalf) {
    if (_uploadedFilePath == null) {
      _showTransientError();
      return;
    }

    // ‚úÖ Speak analysis start message
    _speak("Starting AI analysis of your lung sounds");

    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (_) => StethoscopeUploadLoadingPage(
          chosenSide: 'prediction',
          seedRandom: _random.nextInt(100000),
          uploadedFilePath: _uploadedFilePath!,
          uploadedFileName: _uploadedFileName!,
        ),
      ),
    );
  }

  // ‚úÖ Handle tap for responsive mode toggle
  void _handleTap() {
    _tapResetTimer?.cancel();

    setState(() {
      _tapCount++;

      if (_tapCount >= 15) {
        _responsiveMode = !_responsiveMode;
        _tapCount = 0;

        // ‚úÖ Speak mode change
        _speak(
          _responsiveMode
              ? 'Responsive mode enabled'
              : 'Responsive mode disabled',
        );

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              _responsiveMode
                  ? '‚úÖ Responsive mode ENABLED'
                  : '‚ùå Responsive mode DISABLED',
            ),
            duration: Duration(seconds: 1),
            backgroundColor: _responsiveMode ? Colors.green : Colors.orange,
          ),
        );
      }
    });

    // Reset tap count after 2 seconds of inactivity
    _tapResetTimer = Timer(const Duration(seconds: 2), () {
      if (mounted) {
        setState(() => _tapCount = 0);
      }
    });
  }

  // ‚úÖ Calculate scaled value based on screen size
  double _scale(
    double value,
    double screenDimension,
    double referenceDimension,
  ) {
    if (!_responsiveMode) return value;
    return value * (screenDimension / referenceDimension);
  }

  @override
  void dispose() {
    _tapResetTimer?.cancel();
    _flutterTts.stop(); // ‚úÖ ADD: Stop TTS
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // ‚úÖ Get current screen size
    final screenSize = MediaQuery.of(context).size;
    final screenWidth = screenSize.width;
    final screenHeight = screenSize.height;

    // Layout constants (hardcoded for Lenovo Yoga Tab 11: 2000x1200)
    const lungsWidth = 120.0;
    const lungsHeight = 160.0;
    const lungsLeft = 0.0;
    const lungsTop = 0.0;

    const titleFontSize = 60.0;
    const titleLeft = 180.0;
    const titleTop = 30.0;
    const titleColor = Color(0xFF0d3b66);

    const stethoscopeWidth = 430.0;
    const stethoscopeHeight = 600.0;
    const stethoscopeLeft = 50.0;
    const stethoscopeTop = 180.0;
    const stethoscopeBorderRadius = 40.0;

    const buttonWidth = 600.0;
    const buttonHeight = 180.0;
    const buttonBorderRadius = 90.0;
    const buttonColor = Color(0xFF4B0082);
    const buttonTextColor = Colors.white;
    const buttonTextSize = 32.0;
    const iconSize = 130.0;
    const iconTextSpacing = 24.0;

    const btn1Left = 650.0;
    const btn1Top = 220.0;

    const uploadedTextLeft = 650.0;
    const uploadedTextTop = 460.0;
    const uploadedTextSize = 32.0;
    const uploadedTextColor = Colors.black87;

    const btn2Left = 650.0;
    const btn2Top = 500.0;

    return Scaffold(
      body: GestureDetector(
        // ‚úÖ Detect taps anywhere on screen
        onTap: _handleTap,
        behavior: HitTestBehavior.translucent,
        child: Stack(
          children: [
            // Background
            Positioned.fill(
              child: Image.asset('assets/background.png', fit: BoxFit.cover),
            ),

            // Error overlay
            if (_showError)
              Positioned(
                left: 0,
                right: 0,
                top: 0,
                child: AnimatedContainer(
                  duration: const Duration(milliseconds: 200),
                  height: _showError ? 50 : 0,
                  color: Colors.red.withOpacity(0.7),
                  alignment: Alignment.center,
                  child: const Text(
                    'No file uploaded!',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),

            // Lungs logo
            Positioned(
              left: _scale(lungsLeft, screenWidth, _referenceWidth),
              top: _scale(lungsTop, screenHeight, _referenceHeight),
              width: _scale(lungsWidth, screenWidth, _referenceWidth),
              height: _scale(lungsHeight, screenHeight, _referenceHeight),
              child: Image.asset('assets/lungs_ai.png', fit: BoxFit.contain),
            ),

            // Title
            Positioned(
              left: _scale(titleLeft, screenWidth, _referenceWidth),
              top: _scale(titleTop, screenHeight, _referenceHeight),
              child: Text(
                "Analyze Your Lung Sounds With AI",
                style: TextStyle(
                  fontSize: _scale(titleFontSize, screenWidth, _referenceWidth),
                  fontWeight: FontWeight.bold,
                  color: titleColor,
                ),
              ),
            ),

            // Main stethoscope placeholder
            Positioned(
              left: _scale(stethoscopeLeft, screenWidth, _referenceWidth),
              top: _scale(stethoscopeTop, screenHeight, _referenceHeight),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(
                  _scale(stethoscopeBorderRadius, screenWidth, _referenceWidth),
                ),
                child: SizedBox(
                  width: _scale(stethoscopeWidth, screenWidth, _referenceWidth),
                  height: _scale(
                    stethoscopeHeight,
                    screenHeight,
                    _referenceHeight,
                  ),
                  child: Image.asset(
                    'assets/stethoscope_icon.png',
                    fit: BoxFit.cover,
                  ),
                ),
              ),
            ),

            // Upload button
            Positioned(
              left: _scale(btn1Left, screenWidth, _referenceWidth),
              top: _scale(btn1Top, screenHeight, _referenceHeight),
              child: SizedBox(
                width: _scale(buttonWidth, screenWidth, _referenceWidth),
                height: _scale(buttonHeight, screenHeight, _referenceHeight),
                child: ElevatedButton(
                  style: ElevatedButton.styleFrom(
                    backgroundColor: buttonColor,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(
                        _scale(
                          buttonBorderRadius,
                          screenWidth,
                          _referenceWidth,
                        ),
                      ),
                    ),
                    elevation: 8,
                  ),
                  onPressed: _uploadFile,
                  child: Row(
                    children: [
                      SizedBox(
                        width: _scale(iconSize, screenWidth, _referenceWidth),
                        height: _scale(iconSize, screenWidth, _referenceWidth),
                        child: Image.asset('assets/upload_icon.png'),
                      ),
                      SizedBox(
                        width: _scale(
                          iconTextSpacing,
                          screenWidth,
                          _referenceWidth,
                        ),
                      ),
                      Expanded(
                        child: Text(
                          "Upload Your Lung Sounds for AI Analysis",
                          style: TextStyle(
                            fontSize: _scale(
                              buttonTextSize,
                              screenWidth,
                              _referenceWidth,
                            ),
                            fontWeight: FontWeight.bold,
                            color: buttonTextColor,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),

            // Uploaded file text
            Positioned(
              left: _scale(uploadedTextLeft, screenWidth, _referenceWidth),
              top: _scale(uploadedTextTop, screenHeight, _referenceHeight),
              child: Text(
                "Uploaded File: ${_uploadedFileName ?? 'None'}",
                style: TextStyle(
                  fontSize: _scale(
                    uploadedTextSize,
                    screenWidth,
                    _referenceWidth,
                  ),
                  color: uploadedTextColor,
                ),
              ),
            ),

            // Analyze button
            Positioned(
              left: _scale(btn2Left, screenWidth, _referenceWidth),
              top: _scale(btn2Top, screenHeight, _referenceHeight),
              child: SizedBox(
                width: _scale(buttonWidth, screenWidth, _referenceWidth),
                height: _scale(buttonHeight, screenHeight, _referenceHeight),
                child: GestureDetector(
                  behavior: HitTestBehavior.opaque,
                  onTapDown: (details) {
                    final dx = details.localPosition.dx;
                    if (_uploadedFilePath == null) {
                      _showTransientError();
                      return;
                    }
                    final scaledButtonWidth = _scale(
                      buttonWidth,
                      screenWidth,
                      _referenceWidth,
                    );
                    if (dx < scaledButtonWidth / 2) {
                      _startAnalysisByHalfTap(true);
                    } else {
                      _startAnalysisByHalfTap(false);
                    }
                  },
                  child: ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: buttonColor,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(
                          _scale(
                            buttonBorderRadius,
                            screenWidth,
                            _referenceWidth,
                          ),
                        ),
                      ),
                      elevation: 8,
                    ),
                    onPressed: () {
                      if (_uploadedFilePath == null) {
                        _showTransientError();
                        return;
                      }
                      _startAnalysisByHalfTap(true);
                    },
                    child: Row(
                      children: [
                        SizedBox(
                          width: _scale(iconSize, screenWidth, _referenceWidth),
                          height: _scale(
                            iconSize,
                            screenWidth,
                            _referenceWidth,
                          ),
                          child: Image.asset('assets/ai_icon.png'),
                        ),
                        SizedBox(
                          width: _scale(
                            iconTextSpacing,
                            screenWidth,
                            _referenceWidth,
                          ),
                        ),
                        Expanded(
                          child: Text(
                            "Proceed To AI Analyzation",
                            style: TextStyle(
                              fontSize: _scale(
                                buttonTextSize,
                                screenWidth,
                                _referenceWidth,
                              ),
                              fontWeight: FontWeight.bold,
                              color: buttonTextColor,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),

            // ‚úÖ Speaking indicator
            if (_isSpeaking)
              Positioned(
                top: 20,
                right: 20,
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 5,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.blue.shade400.withOpacity(0.8),
                    borderRadius: BorderRadius.circular(15),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: const [
                      Icon(Icons.volume_up, color: Colors.white, size: 16),
                      SizedBox(width: 5),
                      Text(
                        'Speaking',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
                ),
              ),

            // ‚úÖ Tap counter indicator (appears while tapping)
            if (_tapCount > 0)
              Positioned(
                bottom: 10,
                right: 10,
                child: Container(
                  padding: EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.black54,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    'Taps: $_tapCount/15 ${_responsiveMode ? "(Responsive ON)" : ""}',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }
}


       --- File Content End ---


    üìÑ stethoscope_upload_loading.dart

       --- File Content Start ---

// lib/stethoscope_upload_loading.dart
import 'dart:async';
import 'dart:math';
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'result_stethoscope.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/services.dart';
import 'auth.dart';

class StethoscopeUploadLoadingPage extends StatefulWidget {
  final String chosenSide;
  final int seedRandom;
  final String uploadedFileName;
  final String uploadedFilePath;

  const StethoscopeUploadLoadingPage({
    super.key,
    required this.chosenSide,
    required this.seedRandom,
    required this.uploadedFileName,
    required this.uploadedFilePath,
  });

  @override
  State<StethoscopeUploadLoadingPage> createState() =>
      _StethoscopeUploadLoadingPageState();
}

class _StethoscopeUploadLoadingPageState
    extends State<StethoscopeUploadLoadingPage>
    with TickerProviderStateMixin {
  static const String backgroundAsset = 'assets/background.png';
  static const String lungsAsset = 'assets/lungs_ai.png';

  SharedPreferences? _prefs;
  bool _patternVerified = false;

  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  bool _loadingStarted = false;
  late final Random _rnd;
  late final int _delayMs;
  final List<String> _logs = [];

  final List<String> _messages = [
    'Filtering background noise...',
    'Normalizing spectral bands...',
    'Detecting crackles and wheezes...',
    'Running temporal envelope analysis...',
    'Calibrating AI model...',
    'Comparing against verified cases...',
    'Extracting spectral fingerprints...',
    'Applying denoise filter...',
    'Scoring probable events...',
    'Preparing final report...',
  ];
  int _msgIndex = 0;
  Timer? _msgTicker;

  late AnimationController _lungsController;
  late Animation<double> _lungsScale;

  static const _pythonChannel = MethodChannel('ai_inference');

  // ‚úÖ Responsive mode tracking
  int _tapCount = 0;
  bool _responsiveMode = false;
  Timer? _tapResetTimer;

  // ‚úÖ Reference screen size (Lenovo Yoga Tab 11: 2000 x 1200)
  static const double _referenceWidth = 2000.0;
  static const double _referenceHeight = 1200.0;

  @override
  void initState() {
    super.initState();
    _rnd = Random(widget.seedRandom);
    _initTts(); // ‚úÖ ADD: Initialize TTS
    _initAuth();

    _lungsController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    )..repeat(reverse: true);
    _lungsScale = Tween<double>(begin: 0.92, end: 1.08).animate(
      CurvedAnimation(parent: _lungsController, curve: Curves.easeInOut),
    );
  }

  // ‚úÖ ADD: Initialize TTS
  Future<void> _initTts() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  Future<void> _initAuth() async {
    // ‚úÖ Speak authentication message
    await _speak("Authentication required to proceed");

    final ok = await AppAuth.ensureAuthenticated(context);
    if (!mounted) return;
    if (ok) {
      setState(() => _patternVerified = true);

      // ‚úÖ Speak authentication success
      await _speak("Authentication successful. Starting analysis");

      _startLoadingSequence();
    }
  }

  void _showTemporaryMessage(
    String text, {
    bool isError = false,
    int ms = 900,
  }) {
    final snack = SnackBar(
      content: Text(text),
      backgroundColor: isError ? Colors.redAccent : Colors.black87,
      duration: Duration(milliseconds: ms),
    );
    ScaffoldMessenger.of(context).removeCurrentSnackBar();
    ScaffoldMessenger.of(context).showSnackBar(snack);

    // ‚úÖ Speak the message
    _speak(text);
  }

  // ‚úÖ Handle tap for responsive mode toggle
  void _handleTap() {
    _tapResetTimer?.cancel();

    setState(() {
      _tapCount++;

      if (_tapCount >= 15) {
        _responsiveMode = !_responsiveMode;
        _tapCount = 0;

        final message = _responsiveMode
            ? 'Responsive mode enabled'
            : 'Responsive mode disabled';

        // ‚úÖ Speak mode change
        _speak(message);

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              _responsiveMode
                  ? '‚úÖ Responsive mode ENABLED'
                  : '‚ùå Responsive mode DISABLED',
            ),
            duration: Duration(seconds: 1),
            backgroundColor: _responsiveMode ? Colors.green : Colors.orange,
          ),
        );
      }
    });

    _tapResetTimer = Timer(const Duration(seconds: 2), () {
      if (mounted) {
        setState(() => _tapCount = 0);
      }
    });
  }

  // ‚úÖ Calculate scaled value based on screen size
  double _scale(
    double value,
    double screenDimension,
    double referenceDimension,
  ) {
    if (!_responsiveMode) return value;
    return value * (screenDimension / referenceDimension);
  }

  Future<void> _startLoadingSequence() async {
    if (!mounted) return;
    if (_loadingStarted) return;
    setState(() => _loadingStarted = true);

    _delayMs = 7000 + _rnd.nextInt(3001);
    _logs.add(
      'Stethoscope prediction started at: ${DateTime.now().toIso8601String()}',
    );
    _logs.add('File name: ${widget.uploadedFileName}');
    _logs.add('File path: ${widget.uploadedFilePath}');

    _msgIndex = 0;

    // ‚úÖ Speak first message
    _speak(_messages[_msgIndex]);

    _msgTicker?.cancel();
    _msgTicker = Timer.periodic(const Duration(milliseconds: 1500), (_) {
      if (!mounted) return;
      setState(() => _msgIndex = (_msgIndex + 1) % _messages.length);

      // ‚úÖ Speak each analysis step (but not too frequently)
      // Only speak every other message to avoid overwhelming
      if (_msgIndex % 2 == 0) {
        _speak(_messages[_msgIndex]);
      }
    });

    await Future.delayed(Duration(milliseconds: _delayMs));

    _msgTicker?.cancel();

    Map<String, double> result = {};
    try {
      _logs.add('Invoking Python channel: ai_inference.predictStethoscope');

      final Map<dynamic, dynamic> pyResult = await _pythonChannel.invokeMethod(
        'predictStethoscope',
        {'audio': widget.uploadedFilePath},
      );

      _logs.add('Python inference successful: $pyResult');

      final confidenceMap = Map<String, dynamic>.from(pyResult['confidence']);
      result = {
        'normal': (confidenceMap['Normal'] ?? 0.0) * 100,
        'wheeze': (confidenceMap['Wheeze'] ?? 0.0) * 100,
        'crackle': (confidenceMap['Crackle'] ?? 0.0) * 100,
        'both': (confidenceMap['Both'] ?? 0.0) * 100,
      };

      _logs.add('Mapped UI percentages: $result');

      // ‚úÖ Speak analysis complete
      await _speak("Analysis complete. Displaying results");
    } on PlatformException catch (e) {
      print('Python inference failed: $e');
      _showTemporaryMessage(
        'AI inference failed, showing random result',
        isError: true,
      );
      _logs.add('ERROR: Python inference failed: ${e.code} - ${e.message}');
      _logs.add('Details: ${e.details}');

      result = _generatePercentages(widget.chosenSide);
      _logs.add('Fallback random percentages: $result');
    } catch (e) {
      print('Unexpected error: $e');
      _logs.add('ERROR: Unexpected error: $e');

      result = _generatePercentages(widget.chosenSide);
      _logs.add('Fallback random percentages: $result');
    }

    final mainLabel = _determineMainLabel(result);
    _logs.add('Determined main label: $mainLabel');

    if (!mounted) return;
    Navigator.of(context).pushReplacement(
      MaterialPageRoute(
        builder: (_) => ResultStethoscopePage(
          percentages: result,
          mainLabel: mainLabel,
          logs: List<String>.from(_logs),
        ),
      ),
    );
  }

  Map<String, double> _generatePercentages(String chosen) {
    final r = Random();
    double normal = r.nextDouble() * 30;
    double wheeze = r.nextDouble() * 30;
    double crackle = r.nextDouble() * 30;
    double both = r.nextDouble() * 20;

    if (chosen == 'normal') {
      normal += 45 + r.nextDouble() * 15;
    } else if (chosen == 'wheeze') {
      wheeze += 40 + r.nextDouble() * 20;
    } else if (chosen == 'crackle') {
      crackle += 40 + r.nextDouble() * 20;
    } else if (chosen == 'both') {
      both += 40 + r.nextDouble() * 20;
    } else if (chosen == 'prediction') {
      normal += 20 + r.nextDouble() * 30;
    } else {
      normal += 20 + r.nextDouble() * 30;
    }

    final total = normal + wheeze + crackle + both;
    return {
      'normal': (normal / total) * 100,
      'wheeze': (wheeze / total) * 100,
      'crackle': (crackle / total) * 100,
      'both': (both / total) * 100,
    };
  }

  String _determineMainLabel(Map<String, double> p) {
    final sorted = p.entries.toList()
      ..sort((a, b) => b.value.compareTo(a.value));
    return sorted.first.key;
  }

  @override
  void dispose() {
    _msgTicker?.cancel();
    _tapResetTimer?.cancel();
    _lungsController.dispose();
    _flutterTts.stop(); // ‚úÖ ADD: Stop TTS
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final screenWidth = size.width;
    final screenHeight = size.height;

    // Hardcoded values
    const lungsWidth = 120.0;
    const lungsHeight = 160.0;
    const authFontSize = 22.0;
    const authVerticalPadding = 6.0;
    const authButtonHeight = 14.0;
    const authSpacing = 8.0;
    const loadingSpacing1 = 8.0;
    const loadingLungsSize = 160.0;
    const loadingSpacing2 = 18.0;
    const loadingMessageFontSize = 24.0;
    const loadingSpacing3 = 16.0;
    const loadingFileNameFontSize = 14.0;
    const loadingPathFontSize = 10.0;
    const loadingSpacing4 = 18.0;

    return Scaffold(
      backgroundColor: Colors.transparent,
      body: GestureDetector(
        // ‚úÖ Detect taps anywhere on screen
        onTap: _handleTap,
        behavior: HitTestBehavior.translucent,
        child: Stack(
          children: [
            Positioned.fill(
              child: Image.asset(backgroundAsset, fit: BoxFit.cover),
            ),
            Positioned(
              left: 0,
              top: 0,
              width: _scale(lungsWidth, screenWidth, _referenceWidth),
              height: _scale(lungsHeight, screenHeight, _referenceHeight),
              child: Image.asset(lungsAsset, fit: BoxFit.contain),
            ),
            Positioned.fill(
              child: SafeArea(
                child: Center(
                  child: SingleChildScrollView(
                    physics: const NeverScrollableScrollPhysics(),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        if (!_patternVerified)
                          Column(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Padding(
                                padding: EdgeInsets.symmetric(
                                  vertical: _scale(
                                    authVerticalPadding,
                                    screenHeight,
                                    _referenceHeight,
                                  ),
                                ),
                                child: Text(
                                  'Authentication required',
                                  style: TextStyle(
                                    fontSize: _scale(
                                      authFontSize,
                                      screenWidth,
                                      _referenceWidth,
                                    ),
                                    color: Colors.black87,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                              ),
                              SizedBox(
                                height: _scale(
                                  authButtonHeight,
                                  screenHeight,
                                  _referenceHeight,
                                ),
                              ),
                              ElevatedButton(
                                onPressed: _initAuth,
                                child: const Text('Unlock'),
                              ),
                              SizedBox(
                                height: _scale(
                                  authSpacing,
                                  screenHeight,
                                  _referenceHeight,
                                ),
                              ),
                            ],
                          ),
                        if (_patternVerified)
                          Column(
                            children: [
                              SizedBox(
                                height: _scale(
                                  loadingSpacing1,
                                  screenHeight,
                                  _referenceHeight,
                                ),
                              ),
                              AnimatedOpacity(
                                opacity: 1.0,
                                duration: const Duration(milliseconds: 400),
                                child: Column(
                                  children: [
                                    SizedBox(
                                      width: _scale(
                                        loadingLungsSize,
                                        screenWidth,
                                        _referenceWidth,
                                      ),
                                      height: _scale(
                                        loadingLungsSize,
                                        screenHeight,
                                        _referenceHeight,
                                      ),
                                      child: ScaleTransition(
                                        scale: _lungsScale,
                                        child: Image.asset(
                                          lungsAsset,
                                          fit: BoxFit.contain,
                                        ),
                                      ),
                                    ),
                                    SizedBox(
                                      height: _scale(
                                        loadingSpacing2,
                                        screenHeight,
                                        _referenceHeight,
                                      ),
                                    ),
                                    SizedBox(
                                      width: _responsiveMode
                                          ? screenWidth * 0.8
                                          : size.width * 0.8,
                                      child: AnimatedSwitcher(
                                        duration: const Duration(
                                          milliseconds: 600,
                                        ),
                                        transitionBuilder: (child, anim) {
                                          final offsetAnim = Tween<Offset>(
                                            begin: const Offset(0, 0.2),
                                            end: Offset.zero,
                                          ).animate(anim);
                                          return SlideTransition(
                                            position: offsetAnim,
                                            child: FadeTransition(
                                              opacity: anim,
                                              child: child,
                                            ),
                                          );
                                        },
                                        child: Text(
                                          _messages[_msgIndex],
                                          key: ValueKey<int>(_msgIndex),
                                          textAlign: TextAlign.center,
                                          style: TextStyle(
                                            fontSize: _scale(
                                              loadingMessageFontSize,
                                              screenWidth,
                                              _referenceWidth,
                                            ),
                                            color: Colors.black87,
                                            fontWeight: FontWeight.w600,
                                          ),
                                        ),
                                      ),
                                    ),
                                    SizedBox(
                                      height: _scale(
                                        loadingSpacing3,
                                        screenHeight,
                                        _referenceHeight,
                                      ),
                                    ),
                                    Text(
                                      'Analyzing: ${widget.uploadedFileName}',
                                      style: TextStyle(
                                        fontSize: _scale(
                                          loadingFileNameFontSize,
                                          screenWidth,
                                          _referenceWidth,
                                        ),
                                        color: Colors.black54,
                                      ),
                                    ),
                                    if (kDebugMode)
                                      Padding(
                                        padding: EdgeInsets.all(
                                          _scale(
                                            8.0,
                                            screenWidth,
                                            _referenceWidth,
                                          ),
                                        ),
                                        child: Text(
                                          'Path: ${widget.uploadedFilePath}',
                                          style: TextStyle(
                                            fontSize: _scale(
                                              loadingPathFontSize,
                                              screenWidth,
                                              _referenceWidth,
                                            ),
                                            color: Colors.black38,
                                          ),
                                          textAlign: TextAlign.center,
                                        ),
                                      ),
                                    SizedBox(
                                      height: _scale(
                                        loadingSpacing4,
                                        screenHeight,
                                        _referenceHeight,
                                      ),
                                    ),
                                    if (!_loadingStarted)
                                      ElevatedButton(
                                        onPressed: _startLoadingSequence,
                                        child: const Text('Start Analysis'),
                                      ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                      ],
                    ),
                  ),
                ),
              ),
            ),

            // ‚úÖ ADD: Speaking indicator
            if (_isSpeaking)
              Positioned(
                top: 20,
                right: 20,
                child: Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 10,
                    vertical: 5,
                  ),
                  decoration: BoxDecoration(
                    color: Colors.blue.shade400.withOpacity(0.8),
                    borderRadius: BorderRadius.circular(15),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: const [
                      Icon(Icons.volume_up, color: Colors.white, size: 16),
                      SizedBox(width: 5),
                      Text(
                        'Speaking',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ],
                  ),
                ),
              ),

            // ‚úÖ Tap counter indicator (appears while tapping)
            if (_tapCount > 0)
              Positioned(
                bottom: 10,
                right: 10,
                child: Container(
                  padding: EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.black54,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    'Taps: $_tapCount/15 ${_responsiveMode ? "(Responsive ON)" : ""}',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }
}

// Pattern lock widget & painter (unchanged)
class _PatternLockWidget extends StatefulWidget {
  final double size;
  final double dotRadius;
  final List<int> selected;
  final ValueChanged<List<int>> onUpdateSelected;
  final VoidCallback onComplete;
  final bool isError;
  const _PatternLockWidget({
    required this.size,
    required this.dotRadius,
    required this.selected,
    required this.onUpdateSelected,
    required this.onComplete,
    this.isError = false,
  });

  @override
  State<_PatternLockWidget> createState() => _PatternLockWidgetState();
}

class _PatternLockWidgetState extends State<_PatternLockWidget> {
  final List<int> _sel = [];
  Offset? _current;

  @override
  void initState() {
    super.initState();
    _sel.addAll(widget.selected);
  }

  @override
  void didUpdateWidget(covariant _PatternLockWidget oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (!listEquals(oldWidget.selected, widget.selected)) {
      _sel
        ..clear()
        ..addAll(widget.selected);
    }
  }

  void _updateSelection(Offset localPos) {
    final centers = _computeCenters();
    for (int i = 0; i < centers.length; i++) {
      final d = (localPos - centers[i]).distance;
      if (d <= widget.dotRadius * 1.6 && !_sel.contains(i)) {
        setState(() => _sel.add(i));
        widget.onUpdateSelected(List<int>.from(_sel));
        break;
      }
    }
  }

  List<Offset> _computeCenters() {
    final step = widget.size / 3;
    final centers = <Offset>[];
    for (int r = 0; r < 3; r++) {
      for (int c = 0; c < 3; c++) {
        final cx = (c + 0.5) * step;
        final cy = (r + 0.5) * step;
        centers.add(Offset(cx, cy));
      }
    }
    return centers;
  }

  @override
  Widget build(BuildContext context) {
    final centers = _computeCenters();
    return Listener(
      onPointerDown: (ev) {
        setState(() => _current = ev.localPosition);
        _updateSelection(ev.localPosition);
      },
      onPointerMove: (ev) {
        setState(() => _current = ev.localPosition);
        _updateSelection(ev.localPosition);
      },
      onPointerUp: (ev) {
        setState(() => _current = null);
        widget.onComplete();
      },
      child: CustomPaint(
        size: Size(widget.size, widget.size),
        painter: _PatternPainter(
          centers: centers,
          dotRadius: widget.dotRadius,
          selected: _sel,
          current: _current,
          isError: widget.isError,
        ),
      ),
    );
  }
}

class _PatternPainter extends CustomPainter {
  final List<Offset> centers;
  final double dotRadius;
  final List<int> selected;
  final Offset? current;
  final bool isError;

  _PatternPainter({
    required this.centers,
    required this.dotRadius,
    required this.selected,
    this.current,
    this.isError = false,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paintLine = Paint()
      ..color = isError ? Colors.redAccent : Colors.blueAccent
      ..strokeWidth = dotRadius * 0.45
      ..style = PaintingStyle.stroke
      ..strokeCap = StrokeCap.round;

    final paintDot = Paint()..color = Colors.grey.shade300;
    final paintDotSel = Paint()
      ..color = isError ? Colors.redAccent : Colors.blueAccent;

    if (selected.isNotEmpty) {
      final path = Path();
      path.moveTo(centers[selected[0]].dx, centers[selected[0]].dy);
      for (int i = 1; i < selected.length; i++) {
        path.lineTo(centers[selected[i]].dx, centers[selected[i]].dy);
      }
      canvas.drawPath(path, paintLine);

      if (current != null) {
        final last = centers[selected.last];
        canvas.drawLine(last, current!, paintLine);
      }
    }

    for (int i = 0; i < centers.length; i++) {
      final c = centers[i];
      final bool sel = selected.contains(i);
      canvas.drawCircle(c, dotRadius * 1.15, paintDot);
      canvas.drawCircle(
        c,
        sel ? dotRadius * 0.9 : dotRadius * 0.6,
        sel ? paintDotSel : Paint()
          ..color = Colors.white,
      );
    }
  }

  @override
  bool shouldRepaint(covariant _PatternPainter old) => true;
}

class _PinAuthDialog extends StatefulWidget {
  @override
  State<_PinAuthDialog> createState() => _PinAuthDialogState();
}

class _PinAuthDialogState extends State<_PinAuthDialog> {
  String pin = '';
  String message = '';

  void _addDigit(String d) {
    if (pin.length >= 6) return;
    setState(() => pin += d);
  }

  void _backspace() {
    if (pin.isEmpty) return;
    setState(() => pin = pin.substring(0, pin.length - 1));
  }

  void _confirm() {
    if (pin == '1234') {
      Navigator.of(context).pop(true);
    } else {
      setState(() {
        message = 'Incorrect PIN';
        pin = '';
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    Widget key(String s) => GestureDetector(
      onTap: () => _addDigit(s),
      child: Container(
        margin: const EdgeInsets.all(6),
        width: 58,
        height: 58,
        decoration: BoxDecoration(
          color: Colors.grey.shade200,
          borderRadius: BorderRadius.circular(12),
        ),
        child: Center(child: Text(s, style: const TextStyle(fontSize: 20))),
      ),
    );

    return AlertDialog(
      title: const Text('Enter PIN to change pattern'),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(message, style: const TextStyle(color: Colors.red)),
          const SizedBox(height: 8),
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.grey.shade100,
              borderRadius: BorderRadius.circular(8),
            ),
            child: Text(
              '*' * pin.length,
              style: const TextStyle(fontSize: 24, letterSpacing: 6),
            ),
          ),
          const SizedBox(height: 12),
          Wrap(
            children: [
              for (var r = 1; r <= 9; r++) key('$r'),
              key('0'),
              GestureDetector(
                onTap: _backspace,
                child: Container(
                  margin: const EdgeInsets.all(6),
                  width: 58,
                  height: 58,
                  decoration: BoxDecoration(
                    color: Colors.grey.shade200,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: const Icon(Icons.backspace_outlined),
                ),
              ),
            ],
          ),
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(false),
          child: const Text('Cancel'),
        ),
        ElevatedButton(onPressed: _confirm, child: const Text('Confirm')),
      ],
    );
  }
}


       --- File Content End ---


    üìÑ xray_picture.dart

       --- File Content Start ---

// lib/xray_picture.dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_tts/flutter_tts.dart'; // ‚úÖ ADD THIS
import 'loading_xray.dart';
import 'dart:async';
import 'package:image_picker/image_picker.dart';
import 'scale.dart';

class XRayPicturePage extends StatefulWidget {
  const XRayPicturePage({super.key});

  @override
  _XRayPicturePageState createState() => _XRayPicturePageState();
}

class _XRayPicturePageState extends State<XRayPicturePage> {
  String? _takenPictureName;
  String? _takenPicturePath;
  bool _showError = false;

  final ImagePicker _picker = ImagePicker();

  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  // ‚úÖ ADD: Initialize TTS
  @override
  void initState() {
    super.initState();
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Initialize TTS and speak welcome message
  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US",
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak welcome message
      await Future.delayed(const Duration(milliseconds: 300));
      await _speak("Take a picture of your chest X-ray for AI analysis");
    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  // ‚úÖ ADD: Dispose TTS
  @override
  void dispose() {
    _flutterTts.stop();
    super.dispose();
  }

  // Camera Capture
  Future<void> _takePicture() async {
    try {
      final XFile? photo = await _picker.pickImage(source: ImageSource.camera);

      if (photo != null) {
        setState(() {
          _takenPictureName = photo.name;
          _takenPicturePath = photo.path;
        });

        // ‚úÖ Speak success message
        await _speak(
          "Picture captured successfully. You can now proceed to AI analysis",
        );
      }
    } on PlatformException catch (e) {
      debugPrint("Camera error: $e");
    }
  }

  // Navigate to Loading + Analysis
  void _analyzePicture(String resultType) {
    if (_takenPictureName == null || _takenPicturePath == null) {
      setState(() {
        _showError = true;
      });

      // ‚úÖ Speak error message
      _speak("Please take a picture of your chest X-ray first");

      Timer(const Duration(seconds: 1), () {
        if (mounted) {
          setState(() {
            _showError = false;
          });
        }
      });
      return;
    }

    // ‚úÖ Speak analysis start message
    _speak("Starting AI analysis");

    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => LoadingXRayPage(
          resultType: resultType,
          uploadedFileName: _takenPicturePath!,
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    // --- Layout constants ---
    const lungsWidth = 120.0;
    const lungsHeight = 160.0;
    const lungsLeft = 0.0;
    const lungsTop = 0.0;

    const titleFontSize = 60.0;
    const titleLeft = 180.0;
    const titleTop = 30.0;
    const titleColor = Color(0xFF0d3b66);

    const xrayWidth = 400.0;
    const xrayHeight = 500.0;
    const xrayLeft = 50.0;
    const xrayTop = 200.0;
    const xrayBorderRadius = 40.0;

    const buttonWidth = 600.0;
    const buttonHeight = 180.0;
    const buttonBorderRadius = 90.0;
    const buttonBackgroundColor = Color(0xFF4B0082);
    const buttonTextSize = 32.0;
    const buttonTextColor = Colors.white;
    const iconSize = 130.0;
    const iconTextSpacing = 24.0;

    const btn1Left = 650.0;
    const btn1Top = 220.0;
    const btn1Icon = 'assets/camera_icon.png';
    const btn1Text = "Take a Picture of Your Chest X-Ray for AI Analyzation";

    const takenTextLeft = 650.0;
    const takenTextTop = 460.0;
    const takenTextSize = 32.0;
    const takenTextColor = Colors.black87;

    const btn2Left = 650.0;
    const btn2Top = 500.0;
    const btn2Icon = 'assets/ai_icon.png';
    const btn2Text = "Proceed To AI Analyzation";

    return Scaffold(
      body: Stack(
        children: [
          // Background
          Positioned.fill(
            child: Image.asset('assets/background.png', fit: BoxFit.cover),
          ),

          // üî¥ Error message
          if (_showError)
            Positioned(
              left: 0,
              right: 0,
              top: 0,
              child: AnimatedContainer(
                duration: const Duration(milliseconds: 200),
                height: _showError ? 50 : 0,
                color: Colors.red.withOpacity(0.7),
                alignment: Alignment.center,
                child: const Text(
                  'No picture taken!',
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),

          // ü´Å Top-left lungs logo
          Positioned(
            left: S.w(context, lungsLeft),
            top: S.h(context, lungsTop),
            child: SizedBox(
              width: S.w(context, lungsWidth),
              height: S.h(context, lungsHeight),
              child: Image.asset('assets/lungs_ai.png', fit: BoxFit.contain),
            ),
          ),

          // üìù Title text
          Positioned(
            left: S.w(context, titleLeft),
            top: S.h(context, titleTop),
            child: Text(
              "Analyze Your Chest X-Ray With AI",
              style: TextStyle(
                fontSize: S.fs(context, titleFontSize),
                fontWeight: FontWeight.bold,
                color: titleColor,
              ),
            ),
          ),

          // ü©ª Main X-ray placeholder
          Positioned(
            left: S.w(context, xrayLeft),
            top: S.h(context, xrayTop),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(
                S.w(context, xrayBorderRadius),
              ),
              child: SizedBox(
                width: S.w(context, xrayWidth),
                height: S.h(context, xrayHeight),
                child: Image.asset('assets/xray_icon.png', fit: BoxFit.cover),
              ),
            ),
          ),

          // üì∑ Camera button
          Positioned(
            left: S.w(context, btn1Left),
            top: S.h(context, btn1Top),
            child: SizedBox(
              width: S.w(context, buttonWidth),
              height: S.h(context, buttonHeight),
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: buttonBackgroundColor,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(
                      S.w(context, buttonBorderRadius),
                    ),
                  ),
                  elevation: 8,
                ),
                onPressed: _takePicture,
                child: Row(
                  children: [
                    SizedBox(
                      width: S.w(context, iconSize),
                      height: S.h(context, iconSize),
                      child: Image.asset(btn1Icon),
                    ),
                    SizedBox(width: S.w(context, iconTextSpacing)),
                    Expanded(
                      child: Text(
                        btn1Text,
                        style: TextStyle(
                          fontSize: S.fs(context, buttonTextSize),
                          fontWeight: FontWeight.bold,
                          color: buttonTextColor,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),

          // üìÑ Picture taken text
          Positioned(
            left: S.w(context, takenTextLeft),
            top: S.h(context, takenTextTop),
            child: Text(
              "Picture Taken: ${_takenPictureName ?? 'None'}",
              style: TextStyle(
                fontSize: S.fs(context, takenTextSize),
                color: takenTextColor,
              ),
            ),
          ),

          // ü§ñ Analyze button (same style as above, with split)
          Positioned(
            left: S.w(context, btn2Left),
            top: S.h(context, btn2Top),
            child: SizedBox(
              width: S.w(context, buttonWidth),
              height: S.h(context, buttonHeight),
              child: Stack(
                children: [
                  ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: buttonBackgroundColor,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(
                          S.w(context, buttonBorderRadius),
                        ),
                      ),
                      elevation: 8,
                    ),
                    onPressed: () {},
                    child: Row(
                      children: [
                        SizedBox(
                          width: S.w(context, iconSize),
                          height: S.h(context, buttonHeight),
                          child: Image.asset(btn2Icon),
                        ),
                        SizedBox(width: S.w(context, iconTextSpacing)),
                        Expanded(
                          child: Text(
                            btn2Text,
                            style: TextStyle(
                              fontSize: S.fs(context, buttonTextSize),
                              fontWeight: FontWeight.bold,
                              color: buttonTextColor,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  // Invisible split tap zones
                  Positioned.fill(
                    child: Row(
                      children: [
                        Expanded(
                          child: GestureDetector(
                            behavior: HitTestBehavior.translucent,
                            onTap: () => _analyzePicture("prediction"),
                          ),
                        ),
                        Expanded(
                          child: GestureDetector(
                            behavior: HitTestBehavior.translucent,
                            onTap: () {
                              // Let the actual prediction determine the result type
                              _analyzePicture("prediction");
                            },
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),

          // ‚úÖ ADD: Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 20,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 10,
                  vertical: 5,
                ),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.8),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 16),
                    SizedBox(width: 5),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }
}


       --- File Content End ---


    üìÑ xray_upload.dart

       --- File Content Start ---

// lib/xray_upload.dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_tts/flutter_tts.dart';  // ‚úÖ ADD THIS
import 'loading_xray.dart';
import 'dart:async';
import 'package:file_picker/file_picker.dart';
import 'scale.dart';

class XRayUploadPage extends StatefulWidget {
  const XRayUploadPage({super.key});

  @override
  _XRayUploadPageState createState() => _XRayUploadPageState();
}

class _XRayUploadPageState extends State<XRayUploadPage> {
  String? _uploadedFileName;
  String? _uploadedFilePath;
  bool _showError = false;

  // ‚úÖ ADD TTS
  late FlutterTts _flutterTts;
  bool _isSpeaking = false;

  // ‚úÖ ADD: Initialize TTS
  @override
  void initState() {
    super.initState();
    _initTtsAndSpeak();
  }

  // ‚úÖ ADD: Initialize TTS and speak welcome message
  Future<void> _initTtsAndSpeak() async {
    _flutterTts = FlutterTts();

    try {
      await _flutterTts.setLanguage("en-US");
      await _flutterTts.setSpeechRate(0.5);
      await _flutterTts.setVolume(1.0);
      await _flutterTts.setPitch(1.0);

      if (Theme.of(context).platform == TargetPlatform.android) {
        await _flutterTts.setVoice({
          "name": "en-us-x-tpf-network",
          "locale": "en-US"
        });
      }

      _flutterTts.setStartHandler(() {
        if (mounted) setState(() => _isSpeaking = true);
      });

      _flutterTts.setCompletionHandler(() {
        if (mounted) setState(() => _isSpeaking = false);
      });

      _flutterTts.setErrorHandler((msg) {
        debugPrint("TTS Error: $msg");
        if (mounted) setState(() => _isSpeaking = false);
      });

      // ‚úÖ Speak welcome message
      await Future.delayed(const Duration(milliseconds: 300));
      await _speak("Upload your chest X-ray for AI analysis");

    } catch (e) {
      debugPrint("‚ùå TTS error: $e");
    }
  }

  // ‚úÖ ADD: Speak method
  Future<void> _speak(String text) async {
    try {
      if (_isSpeaking) {
        await _flutterTts.stop();
      }
      debugPrint("üîä Speaking: $text");
      await _flutterTts.speak(text);
    } catch (e) {
      debugPrint("‚ùå TTS speak error: $e");
    }
  }

  // ‚úÖ ADD: Dispose TTS
  @override
  void dispose() {
    _flutterTts.stop();
    super.dispose();
  }

  // File Upload
  Future<void> _uploadFile() async {
    try {
      FilePickerResult? result = await FilePicker.platform.pickFiles(
        type: FileType.image,
      );

      if (result != null && result.files.isNotEmpty) {
        setState(() {
          _uploadedFileName = result.files.single.name;
          _uploadedFilePath = result.files.single.path;
        });
        
        // ‚úÖ Speak success message
        await _speak("File uploaded successfully. You can now proceed to AI analysis");
      }
    } on PlatformException catch (e) {
      debugPrint("File picker error: $e");
    }
  }

  // Navigate to Loading + Analysis
  void _analyzeFile(String resultType) {
    if (_uploadedFileName == null || _uploadedFilePath == null) {
      setState(() {
        _showError = true;
      });
      
      // ‚úÖ Speak error message
      _speak("Please upload a chest X-ray first");
      
      Timer(const Duration(seconds: 1), () {
        if (mounted) {
          setState(() {
            _showError = false;
          });
        }
      });
      return;
    }

    // ‚úÖ Speak analysis start message
    _speak("Starting AI analysis");

    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => LoadingXRayPage(
          resultType: resultType,
          uploadedFileName: _uploadedFilePath!,
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    // --- Layout constants ---
    const lungsWidth = 120.0;
    const lungsHeight = 160.0;
    const lungsLeft = 0.0;
    const lungsTop = 0.0;

    const titleFontSize = 60.0;
    const titleLeft = 180.0;
    const titleTop = 30.0;
    const titleColor = Color(0xFF0d3b66);

    const xrayWidth = 400.0;
    const xrayHeight = 500.0;
    const xrayLeft = 50.0;
    const xrayTop = 200.0;
    const xrayBorderRadius = 40.0;

    const buttonWidth = 600.0;
    const buttonHeight = 190.0;
    const buttonBorderRadius = 90.0;
    const buttonBackgroundColor = Color(0xFF4B0082);
    const buttonTextSize = 32.0;
    const buttonTextColor = Colors.white;
    const iconSize = 130.0;
    const iconTextSpacing = 24.0;

    const btn1Left = 650.0;
    const btn1Top = 220.0;
    const btn1Icon = 'assets/upload_icon.png';
    const btn1Text = "Upload Your Chest X-Ray for AI Analyzation";

    const uploadedTextLeft = 650.0;
    const uploadedTextTop = 460.0;
    const uploadedTextSize = 32.0;
    const uploadedTextColor = Colors.black87;

    const btn2Left = 650.0;
    const btn2Top = 500.0;
    const btn2Icon = 'assets/ai_icon.png';
    const btn2Text = "Proceed To AI Analyzation";

    return Scaffold(
      body: Stack(
        children: [
          // Background
          Positioned.fill(
            child: Image.asset('assets/background.png', fit: BoxFit.cover),
          ),

          // üî¥ Error message
          if (_showError)
            Positioned(
              left: 0,
              right: 0,
              top: 0,
              child: AnimatedContainer(
                duration: const Duration(milliseconds: 200),
                height: _showError ? 50 : 0,
                color: Colors.red.withOpacity(0.7),
                alignment: Alignment.center,
                child: const Text(
                  'No file uploaded!',
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ),
            ),

          // ü´Å Top-left lungs logo
          Positioned(
            left: S.w(context, lungsLeft),
            top: S.h(context, lungsTop),
            child: SizedBox(
              width: S.w(context, lungsWidth),
              height: S.h(context, lungsHeight),
              child: Image.asset('assets/lungs_ai.png', fit: BoxFit.contain),
            ),
          ),

          // üìù Title text
          Positioned(
            left: S.w(context, titleLeft),
            top: S.h(context, titleTop),
            child: Text(
              "Analyze Your Chest X-Ray With AI",
              style: TextStyle(
                fontSize: S.fs(context, titleFontSize),
                fontWeight: FontWeight.bold,
                color: titleColor,
              ),
            ),
          ),

          // ü©ª Main X-ray placeholder
          Positioned(
            left: S.w(context, xrayLeft),
            top: S.h(context, xrayTop),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(
                S.w(context, xrayBorderRadius),
              ),
              child: SizedBox(
                width: S.w(context, xrayWidth),
                height: S.h(context, xrayHeight),
                child: Image.asset('assets/xray_icon.png', fit: BoxFit.cover),
              ),
            ),
          ),

          // üì¶ Upload button
          Positioned(
            left: S.w(context, btn1Left),
            top: S.h(context, btn1Top),
            child: SizedBox(
              width: S.w(context, buttonWidth),
              height: S.h(context, buttonHeight),
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: buttonBackgroundColor,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(
                      S.w(context, buttonBorderRadius),
                    ),
                  ),
                  elevation: 8,
                ),
                onPressed: _uploadFile,
                child: Row(
                  children: [
                    SizedBox(
                      width: S.w(context, iconSize),
                      height: S.h(context, iconSize),
                      child: Image.asset(btn1Icon),
                    ),
                    SizedBox(width: S.w(context, iconTextSpacing)),
                    Expanded(
                      child: Text(
                        btn1Text,
                        style: TextStyle(
                          fontSize: S.fs(context, buttonTextSize),
                          fontWeight: FontWeight.bold,
                          color: buttonTextColor,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),

          // üìÑ Uploaded file text
          Positioned(
            left: S.w(context, uploadedTextLeft),
            top: S.h(context, uploadedTextTop),
            child: Text(
              "Uploaded File: ${_uploadedFileName ?? 'None'}",
              style: TextStyle(
                fontSize: S.fs(context, uploadedTextSize),
                color: uploadedTextColor,
              ),
            ),
          ),

          // ü§ñ Analyze button (same style, with split)
          Positioned(
            left: S.w(context, btn2Left),
            top: S.h(context, btn2Top),
            child: SizedBox(
              width: S.w(context, buttonWidth),
              height: S.h(context, buttonHeight),
              child: Stack(
                children: [
                  ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: buttonBackgroundColor,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(
                          S.w(context, buttonBorderRadius),
                        ),
                      ),
                      elevation: 8,
                    ),
                    onPressed: () {},
                    child: Row(
                      children: [
                        SizedBox(
                          width: S.w(context, iconSize),
                          height: S.h(context, buttonHeight),
                          child: Image.asset(btn2Icon),
                        ),
                        SizedBox(width: S.w(context, iconTextSpacing)),
                        Expanded(
                          child: Text(
                            btn2Text,
                            style: TextStyle(
                              fontSize: S.fs(context, buttonTextSize),
                              fontWeight: FontWeight.bold,
                              color: buttonTextColor,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  // Invisible split zones
                  Positioned.fill(
                    child: Row(
                      children: [
                        Expanded(
                          child: GestureDetector(
                            behavior: HitTestBehavior.translucent,
                            onTap: () {
                              if (_uploadedFileName == null) {
                                _analyzeFile('');
                                return;
                              }
                              // Let the actual prediction determine the result type
                              _analyzeFile('prediction');
                            },
                          ),
                        ),
                        Expanded(
                          child: GestureDetector(
                            behavior: HitTestBehavior.translucent,
                            onTap: () {
                              if (_uploadedFileName == null) {
                                _analyzeFile('');
                                return;
                              }
                              // Let the actual prediction determine the result type
                              _analyzeFile('prediction');
                            },
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),

          // ‚úÖ ADD: Speaking indicator
          if (_isSpeaking)
            Positioned(
              top: 20,
              right: 20,
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                decoration: BoxDecoration(
                  color: Colors.blue.shade400.withOpacity(0.8),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: const [
                    Icon(Icons.volume_up, color: Colors.white, size: 16),
                    SizedBox(width: 5),
                    Text(
                      'Speaking',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }
}

       --- File Content End ---

